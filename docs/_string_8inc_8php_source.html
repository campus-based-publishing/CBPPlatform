<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CBP Platform: String.inc.php Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">CBP Platform
   &#160;<span id="projectnumber">Version 1</span>
   </div>
   <div id="projectbrief">Campus-based Publishing Platform</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">String.inc.php</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_string_8inc_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">/**</span>
<a name="l00004"></a>00004 <span class="comment"> * @file classes/core/String.inc.php</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (c) 2000-2011 John Willinsky</span>
<a name="l00007"></a>00007 <span class="comment"> * Distributed under the GNU GPL v2. For full terms see the file docs/COPYING.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * @class String</span>
<a name="l00010"></a>00010 <span class="comment"> * @ingroup core</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> * @brief String manipulation wrapper class.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> */</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/*</span>
<a name="l00018"></a>00018 <span class="comment"> * Perl-compatibile regular expression (PCRE) constants:</span>
<a name="l00019"></a>00019 <span class="comment"> * These are defined application-wide for consistency</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="comment">/*</span>
<a name="l00023"></a>00023 <span class="comment"> * RFC-2396 URIs</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * Thanks to the PEAR Validation package (Tomas V.V.Cox &lt;cox@idecnet.com&gt;,</span>
<a name="l00026"></a>00026 <span class="comment"> * Pierre-Alain Joye &lt;pajoye@php.net&gt;, Amir Mohammad Saied &lt;amir@php.net&gt;)</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * Originally published under the &quot;New BSD License&quot;</span>
<a name="l00029"></a>00029 <span class="comment"> * http://www.opensource.org/licenses/bsd-license.php</span>
<a name="l00030"></a>00030 <span class="comment"> */</span>
<a name="l00031"></a>00031 define(<span class="stringliteral">&#39;PCRE_URI&#39;</span>, <span class="stringliteral">&#39;(?:([a-z][-+.a-z0-9]*):)?&#39;</span> .                                         <span class="comment">// Scheme</span>
<a name="l00032"></a>00032                    <span class="stringliteral">&#39;(?://&#39;</span> .
<a name="l00033"></a>00033                    <span class="stringliteral">&#39;(?:((?:%[0-9a-f]{2}|[-a-z0-9_.!~*\&#39;();:\&amp;=+$,])*)@)?&#39;</span> .              <span class="comment">// User</span>
<a name="l00034"></a>00034                    <span class="stringliteral">&#39;(?:((?:[a-z0-9](?:[-a-z0-9]*[a-z0-9])?\.)*[a-z](?:[a-z0-9]+)?\.?)&#39;</span> . <span class="comment">// Hostname</span>
<a name="l00035"></a>00035                    <span class="stringliteral">&#39;|([0-9]{1,3}(?:\.[0-9]{1,3}){3}))&#39;</span> .                                 <span class="comment">// IP Address</span>
<a name="l00036"></a>00036                    <span class="stringliteral">&#39;(?::([0-9]*))?)&#39;</span> .                                                   <span class="comment">// Port</span>
<a name="l00037"></a>00037                    <span class="stringliteral">&#39;((?:/(?:%[0-9a-f]{2}|[-a-z0-9_.!~*\&#39;():@\&amp;=+$,;])*)*/?)?&#39;</span> .          <span class="comment">// Path</span>
<a name="l00038"></a>00038                    <span class="stringliteral">&#39;(?:\?([^#]*))?&#39;</span> .                                                    <span class="comment">// Query String</span>
<a name="l00039"></a>00039                    <span class="stringliteral">&#39;(?:\#((?:%[0-9a-f]{2}|[-a-z0-9_.!~*\&#39;();/?:@\&amp;=+$,])*))?&#39;</span>);          <span class="comment">// Fragment</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">// RFC-2822 email addresses</span>
<a name="l00042"></a>00042 define(<span class="stringliteral">&#39;PCRE_EMAIL_ADDRESS&#39;</span>,
<a name="l00043"></a>00043    <span class="stringliteral">&#39;[-a-z0-9!#\$%&amp;\&#39;\*\+\/=\?\^_\`\{\|\}~]&#39;</span> . <span class="charliteral">&#39;+&#39;</span> . <span class="comment">// One or more atom characters.</span>
<a name="l00044"></a>00044    <span class="stringliteral">&#39;(\.&#39;</span> . <span class="stringliteral">&#39;[-a-z0-9!#\$%&amp;\&#39;\*\+\/=\?\^_\`\{\|\}~]&#39;</span> . <span class="stringliteral">&#39;+)*&#39;</span>. <span class="comment">// Followed by zero or more dot separated sets of one or more atom characters.</span>
<a name="l00045"></a>00045    <span class="charliteral">&#39;@&#39;</span>. <span class="comment">// Followed by an &quot;at&quot; character.</span>
<a name="l00046"></a>00046    <span class="charliteral">&#39;(&#39;</span> . <span class="stringliteral">&#39;([a-z0-9]([-a-z0-9]*[a-z0-9]+)?)&#39;</span> . <span class="stringliteral">&#39;{1,63}\.)+&#39;</span>. <span class="comment">// Followed by one or max 63 domain characters (dot separated).</span>
<a name="l00047"></a>00047    <span class="stringliteral">&#39;([a-z0-9]([-a-z0-9]*[a-z0-9]+)?)&#39;</span> . <span class="stringliteral">&#39;{2,63}&#39;</span> <span class="comment">// Must be followed by one set consisting a period of two or max 63 domain characters.</span>
<a name="l00048"></a>00048    );
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">// Two different types of camel case: one for class names and one for method names</span>
<a name="l00051"></a>00051 define (<span class="stringliteral">&#39;CAMEL_CASE_HEAD_UP&#39;</span>, 0x01);
<a name="l00052"></a>00052 define (<span class="stringliteral">&#39;CAMEL_CASE_HEAD_DOWN&#39;</span>, 0x02);
<a name="l00053"></a><a class="code" href="class_string.html">00053</a> 
<a name="l00054"></a>00054 <span class="keyword">class </span><a class="code" href="class_string.html" title="String manipulation wrapper class.">String</a> {<span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">   /**</span>
<a name="l00056"></a>00056 <span class="comment">    * Perform initialization required for the string wrapper library.</span>
<a name="l00057"></a><a class="code" href="class_string.html#a4be4055f3361d4800e16bc2e2e38cda6">00057</a> <span class="comment">    */</span>
<a name="l00058"></a>00058    <span class="keyword">function</span> <a class="code" href="class_string.html#a4be4055f3361d4800e16bc2e2e38cda6">init</a>() {
<a name="l00059"></a>00059       $clientCharset = <a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">strtolower</a>(<a class="code" href="class_config.html#aacba7217e8b34e2aa4c2d50004fdba2f">Config::getVar</a>(<span class="stringliteral">&#39;i18n&#39;</span>, <span class="stringliteral">&#39;client_charset&#39;</span>));
<a name="l00060"></a>00060 
<a name="l00061"></a>00061       <span class="comment">// Check if mbstring is installed (requires PHP &gt;= 4.3.0)</span>
<a name="l00062"></a>00062       <span class="keywordflow">if</span> (<a class="code" href="class_string.html#a55da6aafff0e3426b17cc74751504e98">String::hasMBString</a>()) {
<a name="l00063"></a>00063          <span class="comment">// mbstring routines are available</span>
<a name="l00064"></a>00064          define(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>, <span class="keyword">true</span>);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066          <span class="comment">// Set up required ini settings for mbstring</span>
<a name="l00067"></a>00067          <span class="comment">// FIXME Do any other mbstring settings need to be set?</span>
<a name="l00068"></a>00068          mb_internal_encoding($clientCharset);
<a name="l00069"></a>00069          mb_substitute_character(<span class="stringliteral">&#39;63&#39;</span>);      <span class="comment">// question mark</span>
<a name="l00070"></a>00070       }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072       <span class="comment">// Define modifier to be used in regexp_* routines</span>
<a name="l00073"></a>00073       <span class="comment">// FIXME Should non-UTF-8 encodings be supported with mbstring?</span>
<a name="l00074"></a>00074       <span class="keywordflow">if</span> ($clientCharset == <span class="stringliteral">&#39;utf-8&#39;</span> &amp;&amp; <a class="code" href="class_string.html#a9e3b0e6007e4babe0e913e722df4a190">String::hasPCREUTF8</a>()) {
<a name="l00075"></a>00075          define(<span class="stringliteral">&#39;PCRE_UTF8&#39;</span>, <span class="charliteral">&#39;u&#39;</span>);
<a name="l00076"></a>00076       } <span class="keywordflow">else</span> {
<a name="l00077"></a>00077          define(<span class="stringliteral">&#39;PCRE_UTF8&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00078"></a>00078       }
<a name="l00079"></a>00079    }
<a name="l00080"></a>00080 <span class="comment"></span>
<a name="l00081"></a>00081 <span class="comment">   /**</span>
<a name="l00082"></a>00082 <span class="comment">    * Check if server has the mbstring library.</span>
<a name="l00083"></a>00083 <span class="comment">    * Currently requires PHP &gt;= 4.3.0 (for mb_strtolower, mb_strtoupper,</span>
<a name="l00084"></a>00084 <span class="comment">    * and mb_substr_count)</span>
<a name="l00085"></a>00085 <span class="comment">    * @return boolean</span>
<a name="l00086"></a><a class="code" href="class_string.html#a55da6aafff0e3426b17cc74751504e98">00086</a> <span class="comment">    */</span>
<a name="l00087"></a>00087    <span class="keyword">function</span> <a class="code" href="class_string.html#a55da6aafff0e3426b17cc74751504e98">hasMBString</a>() {
<a name="l00088"></a>00088       <span class="keyword">static</span> $hasMBString;
<a name="l00089"></a>00089       <span class="keywordflow">if</span> (isset($hasMBString)) <span class="keywordflow">return</span> $hasMBString;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091       <span class="comment">// If string overloading is active, it will break many of the</span>
<a name="l00092"></a>00092       <span class="comment">// native implementations. mbstring.func_overload must be set</span>
<a name="l00093"></a>00093       <span class="comment">// to 0, 1 or 4 in php.ini (string overloading disabled).</span>
<a name="l00094"></a>00094       <span class="keywordflow">if</span> (ini_get(<span class="stringliteral">&#39;mbstring.func_overload&#39;</span>) &amp;&amp; defined(<span class="stringliteral">&#39;MB_OVERLOAD_STRING&#39;</span>)) {
<a name="l00095"></a>00095          $hasMBString = <span class="keyword">false</span>;
<a name="l00096"></a>00096       } <span class="keywordflow">else</span> {
<a name="l00097"></a>00097          $hasMBString = (
<a name="l00098"></a>00098          extension_loaded(<span class="stringliteral">&#39;mbstring&#39;</span>) &amp;&amp;
<a name="l00099"></a>00099          function_exists(<span class="stringliteral">&#39;mb_strlen&#39;</span>) &amp;&amp;
<a name="l00100"></a>00100          function_exists(<span class="stringliteral">&#39;mb_strpos&#39;</span>) &amp;&amp;
<a name="l00101"></a>00101          function_exists(<span class="stringliteral">&#39;mb_strrpos&#39;</span>) &amp;&amp;
<a name="l00102"></a>00102          function_exists(<span class="stringliteral">&#39;mb_substr&#39;</span>) &amp;&amp;
<a name="l00103"></a>00103          function_exists(<span class="stringliteral">&#39;mb_strtolower&#39;</span>) &amp;&amp;
<a name="l00104"></a>00104          function_exists(<span class="stringliteral">&#39;mb_strtoupper&#39;</span>) &amp;&amp;
<a name="l00105"></a>00105          function_exists(<span class="stringliteral">&#39;mb_substr_count&#39;</span>) &amp;&amp;
<a name="l00106"></a>00106          function_exists(<span class="stringliteral">&#39;mb_send_mail&#39;</span>)
<a name="l00107"></a>00107          );
<a name="l00108"></a>00108       }
<a name="l00109"></a>00109       <span class="keywordflow">return</span> $hasMBString;
<a name="l00110"></a>00110    }
<a name="l00111"></a>00111 <span class="comment"></span>
<a name="l00112"></a>00112 <span class="comment">   /**</span>
<a name="l00113"></a>00113 <span class="comment">    * Check if server supports the PCRE_UTF8 modifier.</span>
<a name="l00114"></a>00114 <span class="comment">    * @return boolean</span>
<a name="l00115"></a><a class="code" href="class_string.html#a9e3b0e6007e4babe0e913e722df4a190">00115</a> <span class="comment">    */</span>
<a name="l00116"></a>00116    <span class="keyword">function</span> <a class="code" href="class_string.html#a9e3b0e6007e4babe0e913e722df4a190">hasPCREUTF8</a>() {
<a name="l00117"></a>00117       <span class="comment">// The PCRE_UTF8 modifier is only supported on PHP &gt;= 4.1.0 (*nix) or PHP &gt;= 4.2.3 (win32)</span>
<a name="l00118"></a>00118       <span class="comment">// Evil check to see if PCRE_UTF8 is supported</span>
<a name="l00119"></a>00119       <span class="keywordflow">if</span> (@preg_match(<span class="stringliteral">&#39;//u&#39;</span>, <span class="stringliteral">&#39;&#39;</span>)) {
<a name="l00120"></a>00120          <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00121"></a>00121       } <span class="keywordflow">else</span> {
<a name="l00122"></a>00122          <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00123"></a>00123       }
<a name="l00124"></a>00124    }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126    <span class="comment">//</span>
<a name="l00127"></a>00127    <span class="comment">// Wrappers for basic string manipulation routines.</span>
<a name="l00128"></a>00128    <span class="comment">// See the phputf8 documentation for usage.</span>
<a name="l00129"></a>00129    <span class="comment">//</span>
<a name="l00130"></a>00130 <span class="comment"></span>
<a name="l00131"></a>00131 <span class="comment">   /**</span>
<a name="l00132"></a>00132 <span class="comment">    * @see http://ca.php.net/manual/en/function.strlen.php</span>
<a name="l00133"></a><a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">00133</a> <span class="comment">    */</span>
<a name="l00134"></a>00134    <span class="keyword">function</span> <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>($string) {
<a name="l00135"></a>00135       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00136"></a>00136          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00137"></a>00137       } <span class="keywordflow">else</span> {
<a name="l00138"></a>00138          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00139"></a>00139          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00140"></a>00140       }
<a name="l00141"></a>00141       <span class="keywordflow">return</span> utf8_strlen($string);
<a name="l00142"></a>00142    }
<a name="l00143"></a>00143 <span class="comment"></span>
<a name="l00144"></a>00144 <span class="comment">   /**</span>
<a name="l00145"></a>00145 <span class="comment">    * @see http://ca.php.net/manual/en/function.strpos.php</span>
<a name="l00146"></a><a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">00146</a> <span class="comment">    */</span>
<a name="l00147"></a>00147    <span class="keyword">function</span> <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($haystack, $needle, $offset = 0) {
<a name="l00148"></a>00148       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00149"></a>00149          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00150"></a>00150       } <span class="keywordflow">else</span> {
<a name="l00151"></a>00151          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00152"></a>00152          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00153"></a>00153       }
<a name="l00154"></a>00154       <span class="keywordflow">return</span> utf8_strpos($haystack, $needle, $offset);
<a name="l00155"></a>00155    }
<a name="l00156"></a>00156 <span class="comment"></span>
<a name="l00157"></a>00157 <span class="comment">   /**</span>
<a name="l00158"></a>00158 <span class="comment">    * @see http://ca.php.net/manual/en/function.strrpos.php</span>
<a name="l00159"></a><a class="code" href="class_string.html#a28600b48709a24c17f3e4ad84d9a534f">00159</a> <span class="comment">    */</span>
<a name="l00160"></a>00160    <span class="keyword">function</span> <a class="code" href="class_string.html#a28600b48709a24c17f3e4ad84d9a534f">strrpos</a>($haystack, $needle) {
<a name="l00161"></a>00161       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00162"></a>00162          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00163"></a>00163       } <span class="keywordflow">else</span> {
<a name="l00164"></a>00164          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00165"></a>00165          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167       <span class="keywordflow">return</span> utf8_strrpos($haystack, $needle, $offset);
<a name="l00168"></a>00168    }
<a name="l00169"></a>00169 <span class="comment"></span>
<a name="l00170"></a>00170 <span class="comment">   /**</span>
<a name="l00171"></a>00171 <span class="comment">    * @see http://ca.php.net/manual/en/function.substr.php</span>
<a name="l00172"></a><a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">00172</a> <span class="comment">    */</span>
<a name="l00173"></a>00173    <span class="keyword">function</span> <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($string, $start, $length = <span class="keyword">false</span>) {
<a name="l00174"></a>00174       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00175"></a>00175          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00176"></a>00176       } <span class="keywordflow">else</span> {
<a name="l00177"></a>00177          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00178"></a>00178          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00179"></a>00179          <span class="comment">// The default length value for the native implementation</span>
<a name="l00180"></a>00180          <span class="comment">// differs</span>
<a name="l00181"></a>00181          <span class="keywordflow">if</span> ($length === <span class="keyword">false</span>) $length = null;
<a name="l00182"></a>00182       }
<a name="l00183"></a>00183       <span class="keywordflow">return</span> utf8_substr($string, $start, $length);
<a name="l00184"></a>00184    }
<a name="l00185"></a>00185 <span class="comment"></span>
<a name="l00186"></a>00186 <span class="comment">   /**</span>
<a name="l00187"></a>00187 <span class="comment">    * @see http://ca.php.net/manual/en/function.substr_replace.php</span>
<a name="l00188"></a>00188 <span class="comment">    * Thanks to poster at http://ca.php.net/manual/en/function.substr-replace.php#90146</span>
<a name="l00189"></a><a class="code" href="class_string.html#a030fcb4c8fbe84f75c0530c09588ce86">00189</a> <span class="comment">    */</span>
<a name="l00190"></a>00190    <span class="keyword">function</span> <a class="code" href="class_string.html#a030fcb4c8fbe84f75c0530c09588ce86">substr_replace</a>($string, $replacement, $start, $length = null) {
<a name="l00191"></a>00191       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;mb_substr_replace&#39;</span>) === <span class="keyword">false</span>) {
<a name="l00192"></a>00192          <span class="keyword">function</span> mb_substr_replace($string, $replacement, $start, $length = null) {
<a name="l00193"></a>00193             <span class="keywordflow">if</span> (extension_loaded(<span class="stringliteral">&#39;mbstring&#39;</span>) === <span class="keyword">true</span>) {
<a name="l00194"></a>00194                $string_length = <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">String::strlen</a>($string);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                <span class="keywordflow">if</span> ($start &lt; 0) {
<a name="l00197"></a>00197                   $start = max(0, $string_length + $start);
<a name="l00198"></a>00198                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($start &gt; $string_length) {
<a name="l00199"></a>00199                   $start = $string_length;
<a name="l00200"></a>00200                }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202                <span class="keywordflow">if</span> ($length &lt; 0) {
<a name="l00203"></a>00203                   $length = max(0, $string_length - $start + $length);
<a name="l00204"></a>00204                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((is_null($length) === <span class="keyword">true</span>) || ($length &gt; $string_length)) {
<a name="l00205"></a>00205                   $length = $string_length;
<a name="l00206"></a>00206                }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208                <span class="keywordflow">if</span> (($start + $length) &gt; $string_length) {
<a name="l00209"></a>00209                   $length = $string_length - $start;
<a name="l00210"></a>00210                }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212                <span class="keywordflow">return</span> <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($string, 0, $start) . $replacement . <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($string, $start + $length, $string_length - $start - $length);
<a name="l00213"></a>00213             }
<a name="l00214"></a>00214          }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216          <span class="keywordflow">return</span> (is_null($length) === <span class="keyword">true</span>) ? <a class="code" href="class_string.html#a030fcb4c8fbe84f75c0530c09588ce86">substr_replace</a>($string, $replacement, $start) : <a class="code" href="class_string.html#a030fcb4c8fbe84f75c0530c09588ce86">substr_replace</a>($string, $replacement, $start, $length);
<a name="l00217"></a>00217       }
<a name="l00218"></a>00218    }
<a name="l00219"></a>00219 <span class="comment"></span>
<a name="l00220"></a>00220 <span class="comment">   /**</span>
<a name="l00221"></a>00221 <span class="comment">    * @see http://ca.php.net/manual/en/function.strtolower.php</span>
<a name="l00222"></a><a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">00222</a> <span class="comment">    */</span>
<a name="l00223"></a>00223    <span class="keyword">function</span> <a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">strtolower</a>($string) {
<a name="l00224"></a>00224       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00225"></a>00225          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00226"></a>00226       } <span class="keywordflow">else</span> {
<a name="l00227"></a>00227          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00228"></a>00228          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00229"></a>00229       }
<a name="l00230"></a>00230       <span class="keywordflow">return</span> utf8_strtolower($string);
<a name="l00231"></a>00231    }
<a name="l00232"></a>00232 <span class="comment"></span>
<a name="l00233"></a>00233 <span class="comment">   /**</span>
<a name="l00234"></a>00234 <span class="comment">    * @see http://ca.php.net/manual/en/function.strtoupper.php</span>
<a name="l00235"></a><a class="code" href="class_string.html#ad67a5bd28964cbc9751e13a2119b6925">00235</a> <span class="comment">    */</span>
<a name="l00236"></a>00236    <span class="keyword">function</span> <a class="code" href="class_string.html#ad67a5bd28964cbc9751e13a2119b6925">strtoupper</a>($string) {
<a name="l00237"></a>00237       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00238"></a>00238          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00239"></a>00239       } <span class="keywordflow">else</span> {
<a name="l00240"></a>00240          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00241"></a>00241          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00242"></a>00242       }
<a name="l00243"></a>00243       <span class="keywordflow">return</span> utf8_strtoupper($string);
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245 <span class="comment"></span>
<a name="l00246"></a>00246 <span class="comment">   /**</span>
<a name="l00247"></a>00247 <span class="comment">    * @see http://ca.php.net/manual/en/function.ucfirst.php</span>
<a name="l00248"></a><a class="code" href="class_string.html#a3b164a986c30df6ce7be062dc2c4d771">00248</a> <span class="comment">    */</span>
<a name="l00249"></a>00249    <span class="keyword">function</span> <a class="code" href="class_string.html#a3b164a986c30df6ce7be062dc2c4d771">ucfirst</a>($string) {
<a name="l00250"></a>00250       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00251"></a>00251          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/mbstring/core.php&#39;</span>;
<a name="l00252"></a>00252          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/ucfirst.php&#39;</span>;
<a name="l00253"></a>00253       } <span class="keywordflow">else</span> {
<a name="l00254"></a>00254          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/unicode.php&#39;</span>;
<a name="l00255"></a>00255          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/native/core.php&#39;</span>;
<a name="l00256"></a>00256          require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/ucfirst.php&#39;</span>;
<a name="l00257"></a>00257       }
<a name="l00258"></a>00258       <span class="keywordflow">return</span> utf8_ucfirst($string);
<a name="l00259"></a>00259    }
<a name="l00260"></a>00260 <span class="comment"></span>
<a name="l00261"></a>00261 <span class="comment">   /**</span>
<a name="l00262"></a>00262 <span class="comment">    * @see http://ca.php.net/manual/en/function.substr_count.php</span>
<a name="l00263"></a><a class="code" href="class_string.html#a869ea07433a949a148ea4425072b44be">00263</a> <span class="comment">    */</span>
<a name="l00264"></a>00264    <span class="keyword">function</span> <a class="code" href="class_string.html#a869ea07433a949a148ea4425072b44be">substr_count</a>($haystack, $needle) {
<a name="l00265"></a>00265       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00266"></a>00266          <span class="keywordflow">return</span> mb_substr_count($haystack, $needle); <span class="comment">// Requires PHP &gt;= 4.3.0</span>
<a name="l00267"></a>00267       } <span class="keywordflow">else</span> {
<a name="l00268"></a>00268          <span class="keywordflow">return</span> <a class="code" href="class_string.html#a869ea07433a949a148ea4425072b44be">substr_count</a>($haystack, $needle);
<a name="l00269"></a>00269       }
<a name="l00270"></a>00270    }
<a name="l00271"></a>00271 <span class="comment"></span>
<a name="l00272"></a>00272 <span class="comment">   /**</span>
<a name="l00273"></a>00273 <span class="comment">    * @see http://ca.php.net/manual/en/function.encode_mime_header.php</span>
<a name="l00274"></a><a class="code" href="class_string.html#a4567f91912528be5581c598f4ea18552">00274</a> <span class="comment">    */</span>
<a name="l00275"></a>00275    <span class="keyword">function</span> <a class="code" href="class_string.html#a4567f91912528be5581c598f4ea18552">encode_mime_header</a>($string) {
<a name="l00276"></a>00276       <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;ENABLE_MBSTRING&#39;</span>)) {
<a name="l00277"></a>00277          <span class="keywordflow">return</span> mb_encode_mimeheader($string, mb_internal_encoding(), <span class="charliteral">&#39;B&#39;</span>, MAIL_EOL);
<a name="l00278"></a>00278       }  <span class="keywordflow">else</span> {
<a name="l00279"></a>00279          <span class="keywordflow">return</span> $string;
<a name="l00280"></a>00280       }
<a name="l00281"></a>00281    }
<a name="l00282"></a>00282 <span class="comment"></span>
<a name="l00283"></a>00283 <span class="comment">   /**</span>
<a name="l00284"></a>00284 <span class="comment">    * @see http://ca.php.net/manual/en/function.mail.php</span>
<a name="l00285"></a><a class="code" href="class_string.html#a24e718d9d375fe4e25b624b968e2fae9">00285</a> <span class="comment">    */</span>
<a name="l00286"></a>00286    <span class="keyword">function</span> <a class="code" href="class_string.html#a24e718d9d375fe4e25b624b968e2fae9">mail</a>($to, $subject, $message, $additional_headers = <span class="stringliteral">&#39;&#39;</span>, $additional_parameters = <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00287"></a>00287       <span class="comment">// Cannot use mb_send_mail as it base64 encodes the whole body of the email,</span>
<a name="l00288"></a>00288       <span class="comment">// making it useless for multipart emails</span>
<a name="l00289"></a>00289       <span class="keywordflow">if</span> (empty($additional_parameters)) {
<a name="l00290"></a>00290          <span class="keywordflow">return</span> <a class="code" href="class_string.html#a24e718d9d375fe4e25b624b968e2fae9">mail</a>($to, $subject, $message, $additional_headers);
<a name="l00291"></a>00291       } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292          <span class="keywordflow">return</span> <a class="code" href="class_string.html#a24e718d9d375fe4e25b624b968e2fae9">mail</a>($to, $subject, $message, $additional_headers, $additional_parameters);
<a name="l00293"></a>00293       }
<a name="l00294"></a>00294    }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="comment">//</span>
<a name="l00297"></a>00297    <span class="comment">// Wrappers for PCRE-compatible regular expression routines.</span>
<a name="l00298"></a>00298    <span class="comment">// See the php.net documentation for usage.</span>
<a name="l00299"></a>00299    <span class="comment">//</span>
<a name="l00300"></a>00300 <span class="comment"></span>
<a name="l00301"></a>00301 <span class="comment">   /**</span>
<a name="l00302"></a>00302 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_quote.php</span>
<a name="l00303"></a><a class="code" href="class_string.html#a4b53b4237e3ee692c2c915d3b34adf78">00303</a> <span class="comment">    */</span>
<a name="l00304"></a>00304    <span class="keyword">function</span> <a class="code" href="class_string.html#a4b53b4237e3ee692c2c915d3b34adf78">regexp_quote</a>($string, $delimiter = <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00305"></a>00305       <span class="keywordflow">return</span> preg_quote($string, $delimiter);
<a name="l00306"></a>00306    }
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">   /**</span>
<a name="l00309"></a>00309 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_grep.php</span>
<a name="l00310"></a><a class="code" href="class_string.html#a765f923ada00fd75ac2ae99f3c7dfc3b">00310</a> <span class="comment">    */</span>
<a name="l00311"></a>00311    <span class="keyword">function</span> <a class="code" href="class_string.html#a765f923ada00fd75ac2ae99f3c7dfc3b">regexp_grep</a>($pattern, $input) {
<a name="l00312"></a>00312       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($input)) $input = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($input);
<a name="l00313"></a>00313       <span class="keywordflow">return</span> preg_grep($pattern . PCRE_UTF8, $input);
<a name="l00314"></a>00314    }
<a name="l00315"></a>00315 <span class="comment"></span>
<a name="l00316"></a>00316 <span class="comment">   /**</span>
<a name="l00317"></a>00317 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_match.php</span>
<a name="l00318"></a><a class="code" href="class_string.html#a888d61291881d79950445b6951faa73b">00318</a> <span class="comment">    */</span>
<a name="l00319"></a>00319    <span class="keyword">function</span> <a class="code" href="class_string.html#a888d61291881d79950445b6951faa73b">regexp_match</a>($pattern, $subject) {
<a name="l00320"></a>00320       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00321"></a>00321       <span class="keywordflow">return</span> preg_match($pattern . PCRE_UTF8, $subject);
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 <span class="comment"></span>
<a name="l00324"></a>00324 <span class="comment">   /**</span>
<a name="l00325"></a>00325 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_match_get.php</span>
<a name="l00326"></a><a class="code" href="class_string.html#aad792be269446f7f64e360dbcc7ccfe6">00326</a> <span class="comment">    */</span>
<a name="l00327"></a>00327    <span class="keyword">function</span> <a class="code" href="class_string.html#aad792be269446f7f64e360dbcc7ccfe6">regexp_match_get</a>($pattern, $subject, &amp;$matches) {
<a name="l00328"></a>00328       <span class="comment">// NOTE: This function was created since PHP &lt; 5.x does not support optional reference parameters</span>
<a name="l00329"></a>00329       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00330"></a>00330       <span class="keywordflow">return</span> preg_match($pattern . PCRE_UTF8, $subject, $matches);
<a name="l00331"></a>00331    }
<a name="l00332"></a>00332 <span class="comment"></span>
<a name="l00333"></a>00333 <span class="comment">   /**</span>
<a name="l00334"></a>00334 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_match_all.php</span>
<a name="l00335"></a><a class="code" href="class_string.html#a931743bdcd61c0c239f4cade66b7f262">00335</a> <span class="comment">    */</span>
<a name="l00336"></a>00336    <span class="keyword">function</span> <a class="code" href="class_string.html#a931743bdcd61c0c239f4cade66b7f262">regexp_match_all</a>($pattern, $subject, &amp;$matches) {
<a name="l00337"></a>00337       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00338"></a>00338       <span class="keywordflow">return</span> preg_match_all($pattern . PCRE_UTF8, $subject, $matches);
<a name="l00339"></a>00339    }
<a name="l00340"></a>00340 <span class="comment"></span>
<a name="l00341"></a>00341 <span class="comment">   /**</span>
<a name="l00342"></a>00342 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_replace.php</span>
<a name="l00343"></a><a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">00343</a> <span class="comment">    */</span>
<a name="l00344"></a>00344    <span class="keyword">function</span> <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">regexp_replace</a>($pattern, $replacement, $subject, $limit = -1) {
<a name="l00345"></a>00345       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00346"></a>00346       <span class="keywordflow">return</span> preg_replace($pattern . PCRE_UTF8, $replacement, $subject, $limit);
<a name="l00347"></a>00347    }
<a name="l00348"></a>00348 <span class="comment"></span>
<a name="l00349"></a>00349 <span class="comment">   /**</span>
<a name="l00350"></a>00350 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_replace_callback.php</span>
<a name="l00351"></a><a class="code" href="class_string.html#abb094d8f5e6ad41712eb97cc52b58a85">00351</a> <span class="comment">    */</span>
<a name="l00352"></a>00352    <span class="keyword">function</span> <a class="code" href="class_string.html#abb094d8f5e6ad41712eb97cc52b58a85">regexp_replace_callback</a>($pattern, $callback, $subject, $limit = -1) {
<a name="l00353"></a>00353       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00354"></a>00354       <span class="keywordflow">return</span> preg_replace_callback($pattern . PCRE_UTF8, $callback, $subject, $limit);
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356 <span class="comment"></span>
<a name="l00357"></a>00357 <span class="comment">   /**</span>
<a name="l00358"></a>00358 <span class="comment">    * @see http://ca.php.net/manual/en/function.regexp_split.php</span>
<a name="l00359"></a><a class="code" href="class_string.html#af1f537df21c67930177eab49d5aef1e8">00359</a> <span class="comment">    */</span>
<a name="l00360"></a>00360    <span class="keyword">function</span> <a class="code" href="class_string.html#af1f537df21c67930177eab49d5aef1e8">regexp_split</a>($pattern, $subject, $limit = -1) {
<a name="l00361"></a>00361       <span class="keywordflow">if</span> (PCRE_UTF8 &amp;&amp; !<a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">String::utf8_compliant</a>($subject)) $subject = <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">String::utf8_bad_strip</a>($subject);
<a name="l00362"></a>00362       <span class="keywordflow">return</span> preg_split($pattern . PCRE_UTF8, $subject, $limit);
<a name="l00363"></a>00363    }
<a name="l00364"></a>00364 <span class="comment"></span>
<a name="l00365"></a>00365 <span class="comment">   /**</span>
<a name="l00366"></a>00366 <span class="comment">    * @see http://ca.php.net/manual/en/function.mime_content_type.php</span>
<a name="l00367"></a><a class="code" href="class_string.html#af4f33914f9773c0d241a5653615d5512">00367</a> <span class="comment">    */</span>
<a name="l00368"></a>00368    <span class="keyword">function</span> <a class="code" href="class_string.html#af4f33914f9773c0d241a5653615d5512">mime_content_type</a>($filename) {
<a name="l00369"></a>00369       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;mime_content_type&#39;</span>)) {
<a name="l00370"></a>00370          $result = <a class="code" href="class_string.html#af4f33914f9773c0d241a5653615d5512">mime_content_type</a>($filename);
<a name="l00371"></a>00371          <span class="comment">// mime_content_type appears to return a charset</span>
<a name="l00372"></a>00372          <span class="comment">// (erroneously?) in recent versions of PHP5</span>
<a name="l00373"></a>00373          <span class="keywordflow">if</span> (($i = <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($result, <span class="charliteral">&#39;;&#39;</span>)) !== <span class="keyword">false</span>) {
<a name="l00374"></a>00374             $result = trim(<a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($result, 0, $i));
<a name="l00375"></a>00375          }
<a name="l00376"></a>00376          <span class="keywordflow">return</span> $result;
<a name="l00377"></a>00377       } elseif (function_exists(<span class="stringliteral">&#39;finfo_open&#39;</span>)) {
<a name="l00378"></a>00378          $fi =&amp; <a class="code" href="class_registry.html#aa6c82b60d8d18d74a36c1d27b46165a3">Registry::get</a>(<span class="stringliteral">&#39;fileInfo&#39;</span>, <span class="keyword">true</span>, null);
<a name="l00379"></a>00379          <span class="keywordflow">if</span> ($fi === null) {
<a name="l00380"></a>00380             $fi = finfo_open(FILEINFO_MIME, <a class="code" href="class_config.html#aacba7217e8b34e2aa4c2d50004fdba2f">Config::getVar</a>(<span class="stringliteral">&#39;finfo&#39;</span>, <span class="stringliteral">&#39;mime_database_path&#39;</span>));
<a name="l00381"></a>00381          }
<a name="l00382"></a>00382          <span class="keywordflow">if</span> ($fi !== <span class="keyword">false</span>) {
<a name="l00383"></a>00383             <span class="keywordflow">return</span> strtok(finfo_file($fi, $filename), <span class="stringliteral">&#39; ;&#39;</span>);
<a name="l00384"></a>00384          }
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387       <span class="comment">// Fall back on an external &quot;file&quot; tool</span>
<a name="l00388"></a>00388       $f = escapeshellarg($filename);
<a name="l00389"></a>00389       $result = trim(`file --brief --mime $f`);
<a name="l00390"></a>00390       <span class="comment">// Make sure we just return the mime type.</span>
<a name="l00391"></a>00391       <span class="keywordflow">if</span> (($i = <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($result, <span class="charliteral">&#39;;&#39;</span>)) !== <span class="keyword">false</span>) {
<a name="l00392"></a>00392          $result = trim(<a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($result, 0, $i));
<a name="l00393"></a>00393       }
<a name="l00394"></a>00394       <span class="keywordflow">return</span> $result;
<a name="l00395"></a>00395    }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 <span class="comment"></span>
<a name="l00398"></a>00398 <span class="comment">   /**</span>
<a name="l00399"></a>00399 <span class="comment">    * Strip unsafe HTML from the input text. Covers XSS attacks like scripts,</span>
<a name="l00400"></a>00400 <span class="comment">    * onclick(...) attributes, javascript: urls, and special characters.</span>
<a name="l00401"></a>00401 <span class="comment">    * @param $input string input string</span>
<a name="l00402"></a>00402 <span class="comment">    * @return string</span>
<a name="l00403"></a><a class="code" href="class_string.html#a144fbd5103eb2d57bd333d8fe5102009">00403</a> <span class="comment">    */</span>
<a name="l00404"></a>00404    <span class="keyword">function</span> <a class="code" href="class_string.html#a144fbd5103eb2d57bd333d8fe5102009">stripUnsafeHtml</a>($input) {
<a name="l00405"></a>00405       <span class="comment">// Parts of this implementation were taken from Horde:</span>
<a name="l00406"></a>00406       <span class="comment">// see http://cvs.horde.org/co.php/framework/MIME/MIME/Viewer/html.php.</span>
<a name="l00407"></a>00407 
<a name="l00408"></a>00408       $allowedHtml = <a class="code" href="class_config.html#aacba7217e8b34e2aa4c2d50004fdba2f">Config::getVar</a>(<span class="stringliteral">&#39;security&#39;</span>, <span class="stringliteral">&#39;allowed_html&#39;</span>);
<a name="l00409"></a>00409       <span class="keywordflow">if</span> ($allowedHtml == <span class="stringliteral">&#39;&#39;</span>) $allowedHtml = <span class="stringliteral">&#39;&lt;a&gt; &lt;em&gt; &lt;strong&gt; &lt;cite&gt; &lt;code&gt; &lt;ul&gt; &lt;ol&gt; &lt;li&gt; &lt;dl&gt; &lt;dt&gt; &lt;dd&gt; &lt;b&gt; &lt;i&gt; &lt;u&gt; &lt;img&gt; &lt;sup&gt; &lt;sub&gt; &lt;br&gt; &lt;p&gt;&#39;</span>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411       $html = strip_tags($input, $allowedHtml);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413       <span class="comment">// Change space entities to space characters</span>
<a name="l00414"></a>00414       $html = preg_replace(<span class="stringliteral">&#39;/&amp;#(x0*20|0*32);?/i&#39;</span>, <span class="charliteral">&#39; &#39;</span>, $html);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416       <span class="comment">// Remove non-printable characters</span>
<a name="l00417"></a>00417       $html = preg_replace(<span class="stringliteral">&#39;/&amp;#x?0*([9A-D]|1[0-3]);/i&#39;</span>, <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>, $html);
<a name="l00418"></a>00418       $html = preg_replace(<span class="stringliteral">&#39;/&amp;#x?0*[9A-D]([^0-9A-F]|$)/i&#39;</span>, <span class="stringliteral">&#39;&amp;nbsp\\1&#39;</span>, $html);
<a name="l00419"></a>00419       $html = preg_replace(<span class="stringliteral">&#39;/&amp;#0*(9|1[0-3])([^0-9]|$)/i&#39;</span>, <span class="stringliteral">&#39;&amp;nbsp\\2&#39;</span>, $html);
<a name="l00420"></a>00420 
<a name="l00421"></a>00421       <span class="comment">// Remove overly long numeric entities</span>
<a name="l00422"></a>00422       $html = preg_replace(<span class="stringliteral">&#39;/&amp;#x?0*[0-9A-F]{6,};?/i&#39;</span>, <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>, $html);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424       <span class="comment">/* Get all attribute=&quot;javascript:foo()&quot; tags. This is</span>
<a name="l00425"></a>00425 <span class="comment">      * essentially the regex /(=|url\()(&quot;?)[^&gt;]* script:/ but</span>
<a name="l00426"></a>00426 <span class="comment">      * expanded to catch camouflage with spaces and entities. */</span>
<a name="l00427"></a>00427       $preg    = <span class="stringliteral">&#39;/((&amp;#0*61;?|&amp;#x0*3D;?|=)|&#39;</span>
<a name="l00428"></a>00428          . <span class="stringliteral">&#39;((u|&amp;#0*85;?|&amp;#x0*55;?|&amp;#0*117;?|&amp;#x0*75;?)\s*&#39;</span>
<a name="l00429"></a>00429          . <span class="stringliteral">&#39;(r|&amp;#0*82;?|&amp;#x0*52;?|&amp;#0*114;?|&amp;#x0*72;?)\s*&#39;</span>
<a name="l00430"></a>00430          . <span class="stringliteral">&#39;(l|&amp;#0*76;?|&amp;#x0*4c;?|&amp;#0*108;?|&amp;#x0*6c;?)\s*&#39;</span>
<a name="l00431"></a>00431          . <span class="stringliteral">&#39;(\()))\s*&#39;</span>
<a name="l00432"></a>00432          . <span class="stringliteral">&#39;(&amp;#0*34;?|&amp;#x0*22;?|&quot;|&amp;#0*39;?|&amp;#x0*27;?|\&#39;)?&#39;</span>
<a name="l00433"></a>00433          . <span class="stringliteral">&#39;[^&gt;]*\s*&#39;</span>
<a name="l00434"></a>00434          . <span class="stringliteral">&#39;(s|&amp;#0*83;?|&amp;#x0*53;?|&amp;#0*115;?|&amp;#x0*73;?)\s*&#39;</span>
<a name="l00435"></a>00435          . <span class="stringliteral">&#39;(c|&amp;#0*67;?|&amp;#x0*43;?|&amp;#0*99;?|&amp;#x0*63;?)\s*&#39;</span>
<a name="l00436"></a>00436          . <span class="stringliteral">&#39;(r|&amp;#0*82;?|&amp;#x0*52;?|&amp;#0*114;?|&amp;#x0*72;?)\s*&#39;</span>
<a name="l00437"></a>00437          . <span class="stringliteral">&#39;(i|&amp;#0*73;?|&amp;#x0*49;?|&amp;#0*105;?|&amp;#x0*69;?)\s*&#39;</span>
<a name="l00438"></a>00438          . <span class="stringliteral">&#39;(p|&amp;#0*80;?|&amp;#x0*50;?|&amp;#0*112;?|&amp;#x0*70;?)\s*&#39;</span>
<a name="l00439"></a>00439          . <span class="stringliteral">&#39;(t|&amp;#0*84;?|&amp;#x0*54;?|&amp;#0*116;?|&amp;#x0*74;?)\s*&#39;</span>
<a name="l00440"></a>00440          . <span class="stringliteral">&#39;(:|&amp;#0*58;?|&amp;#x0*3a;?)/i&#39;</span>;
<a name="l00441"></a>00441       $html = preg_replace($preg, <span class="stringliteral">&#39;\1\8PKPCleaned&#39;</span>, $html);
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       <span class="comment">/* Get all on&lt;foo&gt;=&quot;bar()&quot;. NEVER allow these. */</span>
<a name="l00444"></a>00444       $html =  preg_replace(<span class="stringliteral">&#39;/([\s&quot;\&#39;]+&#39;</span>
<a name="l00445"></a>00445          . <span class="stringliteral">&#39;(o|&amp;#0*79;?|&amp;#0*4f;?|&amp;#0*111;?|&amp;#0*6f;?)&#39;</span>
<a name="l00446"></a>00446          . <span class="stringliteral">&#39;(n|&amp;#0*78;?|&amp;#0*4e;?|&amp;#0*110;?|&amp;#0*6e;?)&#39;</span>
<a name="l00447"></a>00447          . <span class="stringliteral">&#39;\w+)\s*=/i&#39;</span>, <span class="stringliteral">&#39;\1PKPCleaned=&#39;</span>, $html);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449       $pattern = array(
<a name="l00450"></a>00450          <span class="stringliteral">&#39;|&lt;([^&gt;]*)&amp;{.*}([^&gt;]*)&gt;|&#39;</span>,
<a name="l00451"></a>00451          <span class="stringliteral">&#39;|&lt;([^&gt;]*)mocha:([^&gt;]*)&gt;|i&#39;</span>,
<a name="l00452"></a>00452          <span class="stringliteral">&#39;|&lt;([^&gt;]*)binding:([^&gt;]*)&gt;|i&#39;</span>
<a name="l00453"></a>00453       );
<a name="l00454"></a>00454       $replace = array(<span class="stringliteral">&#39;&lt;&amp;{;}\3&gt;&#39;</span>, <span class="stringliteral">&#39;&lt;\1PKPCleaned:\2&gt;&#39;</span>, <span class="stringliteral">&#39;&lt;\1PKPCleaned:\2&gt;&#39;</span>);
<a name="l00455"></a>00455       $html = preg_replace($pattern, $replace, $html);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457       <span class="keywordflow">return</span> $html;
<a name="l00458"></a>00458    }
<a name="l00459"></a>00459 <span class="comment"></span>
<a name="l00460"></a>00460 <span class="comment">   /**</span>
<a name="l00461"></a>00461 <span class="comment">    * Convert limited HTML into a string.</span>
<a name="l00462"></a>00462 <span class="comment">    * @param $html string</span>
<a name="l00463"></a>00463 <span class="comment">    * @return string</span>
<a name="l00464"></a><a class="code" href="class_string.html#a0a043c52d9e70e64ac1d0d801df3f30a">00464</a> <span class="comment">    */</span>
<a name="l00465"></a>00465    <span class="keyword">function</span> <a class="code" href="class_string.html#a0a043c52d9e70e64ac1d0d801df3f30a">html2text</a>($html) {
<a name="l00466"></a>00466       $html = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;/&lt;[\/]?p&gt;/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l00467"></a>00467       $html = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;/&lt;li&gt;/&#39;</span>, <span class="stringliteral">&#39;&amp;bull; &#39;</span>, $html);
<a name="l00468"></a>00468       $html = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;/&lt;\/li&gt;/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l00469"></a>00469       $html = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;/&lt;br[ ]?[\/]?&gt;/&#39;</span>, <span class="stringliteral">&quot;\n&quot;</span>, $html);
<a name="l00470"></a>00470       $html = <a class="code" href="class_string.html#a2289c826b199bda16b673519e614816c">String::html2utf</a>(strip_tags($html));
<a name="l00471"></a>00471       <span class="keywordflow">return</span> $html;
<a name="l00472"></a>00472    }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474    <span class="comment">//</span>
<a name="l00475"></a>00475    <span class="comment">// Wrappers for UTF-8 validation routines</span>
<a name="l00476"></a>00476    <span class="comment">// See the phputf8 documentation for usage.</span>
<a name="l00477"></a>00477    <span class="comment">//</span>
<a name="l00478"></a>00478 <span class="comment"></span>
<a name="l00479"></a>00479 <span class="comment">   /**</span>
<a name="l00480"></a>00480 <span class="comment">    * Detect whether a string contains non-ascii multibyte sequences in the UTF-8 range</span>
<a name="l00481"></a>00481 <span class="comment">    * @param $str string input string</span>
<a name="l00482"></a>00482 <span class="comment">    * @return boolean</span>
<a name="l00483"></a><a class="code" href="class_string.html#a047d7d9ae2a4a67842b344b261f20422">00483</a> <span class="comment">    */</span>
<a name="l00484"></a>00484    <span class="keyword">function</span> <a class="code" href="class_string.html#a047d7d9ae2a4a67842b344b261f20422">utf8_is_valid</a>($str) {
<a name="l00485"></a>00485       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/validation.php&#39;</span>;
<a name="l00486"></a>00486       <span class="keywordflow">return</span> <a class="code" href="class_string.html#a047d7d9ae2a4a67842b344b261f20422">utf8_is_valid</a>($str);
<a name="l00487"></a>00487    }
<a name="l00488"></a>00488 <span class="comment"></span>
<a name="l00489"></a>00489 <span class="comment">   /**</span>
<a name="l00490"></a>00490 <span class="comment">    * Tests whether a string complies as UTF-8; faster and less strict than utf8_is_valid</span>
<a name="l00491"></a>00491 <span class="comment">    * see lib/phputf8/utils/validation.php for more details</span>
<a name="l00492"></a>00492 <span class="comment">    * @param $str string input string</span>
<a name="l00493"></a>00493 <span class="comment">    * @return boolean</span>
<a name="l00494"></a><a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">00494</a> <span class="comment">    */</span>
<a name="l00495"></a>00495    <span class="keyword">function</span> <a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">utf8_compliant</a>($str) {
<a name="l00496"></a>00496       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/validation.php&#39;</span>;
<a name="l00497"></a>00497       <span class="keywordflow">return</span> <a class="code" href="class_string.html#a3e9442a7941a576bdd9e76af451be740">utf8_compliant</a>($str);
<a name="l00498"></a>00498    }
<a name="l00499"></a>00499 <span class="comment"></span>
<a name="l00500"></a>00500 <span class="comment">   /**</span>
<a name="l00501"></a>00501 <span class="comment">    * Locates the first bad byte in a UTF-8 string returning it&#39;s byte index in the string</span>
<a name="l00502"></a>00502 <span class="comment">    * @param $str string input string</span>
<a name="l00503"></a>00503 <span class="comment">    * @return string</span>
<a name="l00504"></a><a class="code" href="class_string.html#aab96d462e25f783dbaa442c761779ef2">00504</a> <span class="comment">    */</span>
<a name="l00505"></a>00505    <span class="keyword">function</span> <a class="code" href="class_string.html#aab96d462e25f783dbaa442c761779ef2">utf8_bad_find</a>($str) {
<a name="l00506"></a>00506       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/bad.php&#39;</span>;
<a name="l00507"></a>00507       <span class="keywordflow">return</span> <a class="code" href="class_string.html#aab96d462e25f783dbaa442c761779ef2">utf8_bad_find</a>($str);
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509 <span class="comment"></span>
<a name="l00510"></a>00510 <span class="comment">   /**</span>
<a name="l00511"></a>00511 <span class="comment">    * Strips out any bad bytes from a UTF-8 string and returns the rest</span>
<a name="l00512"></a>00512 <span class="comment">    * @param $str string input string</span>
<a name="l00513"></a>00513 <span class="comment">    * @return string</span>
<a name="l00514"></a><a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">00514</a> <span class="comment">    */</span>
<a name="l00515"></a>00515    <span class="keyword">function</span> <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">utf8_bad_strip</a>($str) {
<a name="l00516"></a>00516       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/bad.php&#39;</span>;
<a name="l00517"></a>00517       <span class="keywordflow">return</span> <a class="code" href="class_string.html#ae73cad41fafc1ae05965ba8937f46cb5">utf8_bad_strip</a>($str);
<a name="l00518"></a>00518    }
<a name="l00519"></a>00519 <span class="comment"></span>
<a name="l00520"></a>00520 <span class="comment">   /**</span>
<a name="l00521"></a>00521 <span class="comment">    * Replace bad bytes with an alternative character - ASCII character</span>
<a name="l00522"></a>00522 <span class="comment">    * @param $str string input string</span>
<a name="l00523"></a>00523 <span class="comment">    * @param $replace string optional</span>
<a name="l00524"></a>00524 <span class="comment">    * @return string</span>
<a name="l00525"></a><a class="code" href="class_string.html#add5777822c45471fc9e3ce3ebd50cd12">00525</a> <span class="comment">    */</span>
<a name="l00526"></a>00526    <span class="keyword">function</span> <a class="code" href="class_string.html#add5777822c45471fc9e3ce3ebd50cd12">utf8_bad_replace</a>($str, $replace = <span class="charliteral">&#39;?&#39;</span>) {
<a name="l00527"></a>00527       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/bad.php&#39;</span>;
<a name="l00528"></a>00528       <span class="keywordflow">return</span> <a class="code" href="class_string.html#add5777822c45471fc9e3ce3ebd50cd12">utf8_bad_replace</a>($str, $replace);
<a name="l00529"></a>00529    }
<a name="l00530"></a>00530 <span class="comment"></span>
<a name="l00531"></a>00531 <span class="comment">   /**</span>
<a name="l00532"></a>00532 <span class="comment">    * Replace bad bytes with an alternative character - ASCII character</span>
<a name="l00533"></a>00533 <span class="comment">    * @param $str string input string</span>
<a name="l00534"></a>00534 <span class="comment">    * @return string</span>
<a name="l00535"></a><a class="code" href="class_string.html#adb09426585db7f1b350a00e80c589cd4">00535</a> <span class="comment">    */</span>
<a name="l00536"></a>00536    <span class="keyword">function</span> <a class="code" href="class_string.html#adb09426585db7f1b350a00e80c589cd4">utf8_strip_ascii_ctrl</a>($str) {
<a name="l00537"></a>00537       require_once <span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utils/ascii.php&#39;</span>;
<a name="l00538"></a>00538       <span class="keywordflow">return</span> <a class="code" href="class_string.html#adb09426585db7f1b350a00e80c589cd4">utf8_strip_ascii_ctrl</a>($str);
<a name="l00539"></a>00539    }
<a name="l00540"></a>00540 <span class="comment"></span>
<a name="l00541"></a>00541 <span class="comment">   /**</span>
<a name="l00542"></a>00542 <span class="comment">    * Normalize a string in an unknown (non-UTF8) encoding into a valid UTF-8 sequence</span>
<a name="l00543"></a>00543 <span class="comment">    * @param $str string input string</span>
<a name="l00544"></a>00544 <span class="comment">    * @return string</span>
<a name="l00545"></a><a class="code" href="class_string.html#a25d29e35d3db4b1bc9aef4b857c75eea">00545</a> <span class="comment">    */</span>
<a name="l00546"></a>00546    <span class="keyword">function</span> <a class="code" href="class_string.html#a25d29e35d3db4b1bc9aef4b857c75eea">utf8_normalize</a>($str) {
<a name="l00547"></a>00547       <span class="keyword">import</span>(<span class="stringliteral">&#39;lib.pkp.classes.core.Transcoder&#39;</span>);
<a name="l00548"></a>00548 
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (<a class="code" href="class_string.html#a55da6aafff0e3426b17cc74751504e98">String::hasMBString</a>()) {
<a name="l00550"></a>00550          <span class="comment">// NB: CP-1252 often segfaults; we&#39;ve left it out here but it will detect as &#39;ISO-8859-1&#39;</span>
<a name="l00551"></a>00551          $mb_encoding_order = <span class="stringliteral">&#39;UTF-8, UTF-7, ASCII, ISO-8859-1, EUC-JP, SJIS, eucJP-win, SJIS-win, JIS, ISO-2022-JP&#39;</span>;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553          <span class="keywordflow">if</span> (<a class="code" href="functions_8inc_8php.html#abd298ae30c307154dc592f0b99625390">checkPhpVersion</a>(<span class="stringliteral">&#39;4.3.8&#39;</span>)) {
<a name="l00554"></a>00554             $detected_encoding = mb_detect_encoding($str, $mb_encoding_order, FALSE);
<a name="l00555"></a>00555          } <span class="keywordflow">else</span> {
<a name="l00556"></a>00556             $detected_encoding = mb_detect_encoding($str, $mb_encoding_order);
<a name="l00557"></a>00557          }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559       } elseif (function_exists(<span class="stringliteral">&#39;iconv&#39;</span>) &amp;&amp; <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>(iconv(<span class="stringliteral">&#39;CP1252&#39;</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>, $str)) != <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>(iconv(<span class="stringliteral">&#39;ISO-8859-1&#39;</span>, <span class="stringliteral">&#39;UTF-8&#39;</span>, $str))) {
<a name="l00560"></a>00560          <span class="comment">// use iconv to detect CP-1252, assuming default ISO-8859-1</span>
<a name="l00561"></a>00561          $detected_encoding = <span class="stringliteral">&#39;CP1252&#39;</span>;
<a name="l00562"></a>00562       } <span class="keywordflow">else</span> {
<a name="l00563"></a>00563          <span class="comment">// assume ISO-8859-1, PHP default</span>
<a name="l00564"></a>00564          $detected_encoding = <span class="stringliteral">&#39;ISO-8859-1&#39;</span>;
<a name="l00565"></a>00565       }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567       <span class="comment">// transcode CP-1252/ISO-8859-1 into HTML entities; this works because CP-1252 is mapped onto ISO-8859-1</span>
<a name="l00568"></a>00568       <span class="keywordflow">if</span> (<span class="stringliteral">&#39;ISO-8859-1&#39;</span> == $detected_encoding || <span class="stringliteral">&#39;CP1252&#39;</span> == $detected_encoding) {
<a name="l00569"></a>00569          $trans = <span class="keyword">new</span> <a class="code" href="class_transcoder.html" title="Multi-class transcoder; uses mbstring and iconv if available, otherwise falls back to built-in classe...">Transcoder</a>(<span class="stringliteral">&#39;CP1252&#39;</span>, <span class="stringliteral">&#39;HTML-ENTITIES&#39;</span>);
<a name="l00570"></a>00570          $str = $trans-&gt;trans($str);
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="comment">// transcode from detected encoding to to UTF-8</span>
<a name="l00574"></a>00574       $trans = <span class="keyword">new</span> <a class="code" href="class_transcoder.html" title="Multi-class transcoder; uses mbstring and iconv if available, otherwise falls back to built-in classe...">Transcoder</a>($detected_encoding, <span class="stringliteral">&#39;UTF-8&#39;</span>);
<a name="l00575"></a>00575       $str = $trans-&gt;trans($str);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="keywordflow">return</span> $str;
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 <span class="comment"></span>
<a name="l00580"></a>00580 <span class="comment">   /**</span>
<a name="l00581"></a>00581 <span class="comment">    * US-ASCII transliterations of Unicode text</span>
<a name="l00582"></a>00582 <span class="comment">    * @param $str string input string</span>
<a name="l00583"></a>00583 <span class="comment">    * @return string</span>
<a name="l00584"></a><a class="code" href="class_string.html#ae6557fb10b0a9fcad40b5fe61154e6b2">00584</a> <span class="comment">    */</span>
<a name="l00585"></a>00585    <span class="keyword">function</span> <a class="code" href="class_string.html#ae6557fb10b0a9fcad40b5fe61154e6b2">utf8_to_ascii</a>($str) {
<a name="l00586"></a>00586       require_once(<span class="stringliteral">&#39;./lib/pkp/lib/phputf8/utf8_to_ascii.php&#39;</span>);
<a name="l00587"></a>00587       <span class="keywordflow">return</span> <a class="code" href="class_string.html#ae6557fb10b0a9fcad40b5fe61154e6b2">utf8_to_ascii</a>($str);
<a name="l00588"></a>00588    }
<a name="l00589"></a>00589 <span class="comment"></span>
<a name="l00590"></a>00590 <span class="comment">   /**</span>
<a name="l00591"></a>00591 <span class="comment">    * Returns the UTF-8 string corresponding to the unicode value</span>
<a name="l00592"></a>00592 <span class="comment">    * Does not require any multibyte PHP libraries</span>
<a name="l00593"></a>00593 <span class="comment">    * (from php.net, courtesy - romans@void.lv)</span>
<a name="l00594"></a>00594 <span class="comment">    * @param $num int</span>
<a name="l00595"></a>00595 <span class="comment">    * @return string</span>
<a name="l00596"></a><a class="code" href="class_string.html#a3953d17aaac8cce6fb10d6d5aeef7111">00596</a> <span class="comment">    */</span>
<a name="l00597"></a>00597    <span class="keyword">function</span> <a class="code" href="class_string.html#a3953d17aaac8cce6fb10d6d5aeef7111">code2utf</a> ($num) {
<a name="l00598"></a>00598       <span class="keywordflow">if</span> ($num &lt; 128) <span class="keywordflow">return</span> chr($num);
<a name="l00599"></a>00599       <span class="keywordflow">if</span> ($num &lt; 2048) <span class="keywordflow">return</span> chr(($num &gt;&gt; 6) + 192) . chr(($num &amp; 63) + 128);
<a name="l00600"></a>00600       <span class="keywordflow">if</span> ($num &lt; 65536) <span class="keywordflow">return</span> chr(($num &gt;&gt; 12) + 224) . chr((($num &gt;&gt; 6) &amp; 63) + 128) . chr(($num &amp; 63) + 128);
<a name="l00601"></a>00601       <span class="keywordflow">if</span> ($num &lt; 2097152) <span class="keywordflow">return</span> chr(($num &gt;&gt; 18) + 240) . chr((($num &gt;&gt; 12) &amp; 63) + 128) . chr((($num &gt;&gt; 6) &amp; 63) + 128) . chr(($num &amp; 63) + 128);
<a name="l00602"></a>00602       <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00603"></a>00603    }
<a name="l00604"></a>00604 <span class="comment"></span>
<a name="l00605"></a>00605 <span class="comment">   /**</span>
<a name="l00606"></a>00606 <span class="comment">    * Convert UTF-8 encoded characters in a string to escaped HTML entities</span>
<a name="l00607"></a>00607 <span class="comment">    * This is a helper function for transcoding into HTML or XML for output</span>
<a name="l00608"></a>00608 <span class="comment">    * @param $str string input string</span>
<a name="l00609"></a>00609 <span class="comment">    * @return string</span>
<a name="l00610"></a><a class="code" href="class_string.html#a3b8693c67539b891a87d5bb8bf5cc7b0">00610</a> <span class="comment">    */</span>
<a name="l00611"></a>00611    <span class="keyword">function</span> <a class="code" href="class_string.html#a3b8693c67539b891a87d5bb8bf5cc7b0">utf2html</a> ($str) {
<a name="l00612"></a>00612       $ret = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00613"></a>00613       $max = <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>($str);
<a name="l00614"></a>00614       $last = 0;  <span class="comment">// keeps the index of the last regular character</span>
<a name="l00615"></a>00615 
<a name="l00616"></a>00616       <span class="keywordflow">for</span> ($i=0; $i&lt;$max; $i++) {
<a name="l00617"></a>00617          $c = $str{$i};
<a name="l00618"></a>00618          $c1 = ord($c);
<a name="l00619"></a>00619          <span class="keywordflow">if</span> ($c1&gt;&gt;5 == 6) {                              <span class="comment">// 110x xxxx, 110 prefix for 2 bytes unicode</span>
<a name="l00620"></a>00620             $ret .= <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($str, $last, $i-$last);       <span class="comment">// append all the regular characters we&#39;ve passed</span>
<a name="l00621"></a>00621             $c1 &amp;= 31;                                      <span class="comment">// remove the 3 bit two bytes prefix</span>
<a name="l00622"></a>00622             $c2 = ord($str{++$i});                       <span class="comment">// the next byte</span>
<a name="l00623"></a>00623             $c2 &amp;= 63;                                      <span class="comment">// remove the 2 bit trailing byte prefix</span>
<a name="l00624"></a>00624             $c2 |= (($c1 &amp; 3) &lt;&lt; 6);                     <span class="comment">// last 2 bits of c1 become first 2 of c2</span>
<a name="l00625"></a>00625             $c1 &gt;&gt;= 2;                                      <span class="comment">// c1 shifts 2 to the right</span>
<a name="l00626"></a>00626             $ret .= <span class="stringliteral">&quot;&amp;#&quot;</span> . ($c1 * 0x100 + $c2) . <span class="stringliteral">&quot;;&quot;</span>; <span class="comment">// this is the fastest string concatenation</span>
<a name="l00627"></a>00627             $last = $i+1;
<a name="l00628"></a>00628          }
<a name="l00629"></a>00629          elseif ($c1&gt;&gt;4 == 14) {                         <span class="comment">// 1110 xxxx, 110 prefix for 3 bytes unicode</span>
<a name="l00630"></a>00630             $ret .= <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($str, $last, $i-$last);       <span class="comment">// append all the regular characters we&#39;ve passed</span>
<a name="l00631"></a>00631             $c2 = ord($str{++$i});                       <span class="comment">// the next byte</span>
<a name="l00632"></a>00632             $c3 = ord($str{++$i});                       <span class="comment">// the third byte</span>
<a name="l00633"></a>00633             $c1 &amp;= 15;                                   <span class="comment">// remove the 4 bit three bytes prefix</span>
<a name="l00634"></a>00634             $c2 &amp;= 63;                                   <span class="comment">// remove the 2 bit trailing byte prefix</span>
<a name="l00635"></a>00635             $c3 &amp;= 63;                                   <span class="comment">// remove the 2 bit trailing byte prefix</span>
<a name="l00636"></a>00636             $c3 |= (($c2 &amp; 3) &lt;&lt; 6);                     <span class="comment">// last 2 bits of c2 become first 2 of c3</span>
<a name="l00637"></a>00637             $c2 &gt;&gt;=2;                                       <span class="comment">//c2 shifts 2 to the right</span>
<a name="l00638"></a>00638             $c2 |= (($c1 &amp; 15) &lt;&lt; 4);                    <span class="comment">// last 4 bits of c1 become first 4 of c2</span>
<a name="l00639"></a>00639             $c1 &gt;&gt;= 4;                                   <span class="comment">// c1 shifts 4 to the right</span>
<a name="l00640"></a>00640             $ret .= <span class="stringliteral">&#39;&amp;#&#39;</span> . (($c1 * 0x10000) + ($c2 * 0x100) + $c3) . <span class="charliteral">&#39;;&#39;</span>; <span class="comment">// this is the fastest string concatenation</span>
<a name="l00641"></a>00641             $last = $i+1;
<a name="l00642"></a>00642          }
<a name="l00643"></a>00643       }
<a name="l00644"></a>00644       $str=$ret . <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($str, $last, $i); <span class="comment">// append the last batch of regular characters</span>
<a name="l00645"></a>00645 
<a name="l00646"></a>00646       <span class="keywordflow">return</span> $str;
<a name="l00647"></a>00647    }
<a name="l00648"></a>00648 <span class="comment"></span>
<a name="l00649"></a>00649 <span class="comment">   /**</span>
<a name="l00650"></a>00650 <span class="comment">    * Convert numeric HTML entities in a string to UTF-8 encoded characters</span>
<a name="l00651"></a>00651 <span class="comment">    * This is a native alternative to the buggy html_entity_decode() using UTF8</span>
<a name="l00652"></a>00652 <span class="comment">    * @param $str string input string</span>
<a name="l00653"></a>00653 <span class="comment">    * @return string</span>
<a name="l00654"></a><a class="code" href="class_string.html#a2289c826b199bda16b673519e614816c">00654</a> <span class="comment">    */</span>
<a name="l00655"></a>00655    <span class="keyword">function</span> <a class="code" href="class_string.html#a2289c826b199bda16b673519e614816c">html2utf</a>($str) {
<a name="l00656"></a>00656       <span class="comment">// convert named entities to numeric entities</span>
<a name="l00657"></a>00657       $str = strtr($str, <a class="code" href="class_string.html#a9b60d28cb59400a5199d40953a873d06">String::getHTMLEntities</a>());
<a name="l00658"></a>00658 
<a name="l00659"></a>00659       <span class="comment">// use PCRE-aware replace function to replace numeric entities</span>
<a name="l00660"></a>00660       $str = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;~&amp;#x([0-9a-f]+);~ei&#39;</span>, <span class="stringliteral">&#39;String::code2utf(hexdec(&quot;\\1&quot;))&#39;</span>, $str);
<a name="l00661"></a>00661       $str = <a class="code" href="class_string.html#a9fa4fd9fd5474929949148f11f18e56e">String::regexp_replace</a>(<span class="stringliteral">&#39;~&amp;#([0-9]+);~e&#39;</span>, <span class="stringliteral">&#39;String::code2utf(\\1)&#39;</span>, $str);
<a name="l00662"></a>00662 
<a name="l00663"></a>00663       <span class="keywordflow">return</span> $str;
<a name="l00664"></a>00664    }
<a name="l00665"></a>00665 <span class="comment"></span>
<a name="l00666"></a>00666 <span class="comment">   /**</span>
<a name="l00667"></a>00667 <span class="comment">    * Return an associative array of named-&gt;numeric HTML entities</span>
<a name="l00668"></a>00668 <span class="comment">    * Required to support HTML functions without objects in PHP4/PHP5</span>
<a name="l00669"></a>00669 <span class="comment">    * From php.net: function.get-html-translation-table.php</span>
<a name="l00670"></a>00670 <span class="comment">    * @return string</span>
<a name="l00671"></a><a class="code" href="class_string.html#a9b60d28cb59400a5199d40953a873d06">00671</a> <span class="comment">    */</span>
<a name="l00672"></a>00672    <span class="keyword">function</span> <a class="code" href="class_string.html#a9b60d28cb59400a5199d40953a873d06">getHTMLEntities</a> () {
<a name="l00673"></a>00673       <span class="comment">// define the conversion table</span>
<a name="l00674"></a>00674       $html_entities = array(
<a name="l00675"></a>00675          <span class="stringliteral">&quot;&amp;Aacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#193;&quot;</span>, <span class="stringliteral">&quot;&amp;aacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#225;&quot;</span>, <span class="stringliteral">&quot;&amp;Acirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#194;&quot;</span>,
<a name="l00676"></a>00676          <span class="stringliteral">&quot;&amp;acirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#226;&quot;</span>,  <span class="stringliteral">&quot;&amp;acute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#180;&quot;</span>,  <span class="stringliteral">&quot;&amp;AElig;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#198;&quot;</span>,
<a name="l00677"></a>00677          <span class="stringliteral">&quot;&amp;aelig;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#230;&quot;</span>,  <span class="stringliteral">&quot;&amp;Agrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#192;&quot;</span>, <span class="stringliteral">&quot;&amp;agrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#224;&quot;</span>,
<a name="l00678"></a>00678          <span class="stringliteral">&quot;&amp;alefsym;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8501;&quot;</span>,<span class="stringliteral">&quot;&amp;Alpha;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#913;&quot;</span>, <span class="stringliteral">&quot;&amp;alpha;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#945;&quot;</span>,
<a name="l00679"></a>00679          <span class="stringliteral">&quot;&amp;amp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#38;&quot;</span>,  <span class="stringliteral">&quot;&amp;and;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8743;&quot;</span>,   <span class="stringliteral">&quot;&amp;ang;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8736;&quot;</span>,
<a name="l00680"></a>00680          <span class="stringliteral">&quot;&amp;apos;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#39;&quot;</span>, <span class="stringliteral">&quot;&amp;Aring;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#197;&quot;</span>,  <span class="stringliteral">&quot;&amp;aring;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#229;&quot;</span>,
<a name="l00681"></a>00681          <span class="stringliteral">&quot;&amp;asymp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8776;&quot;</span>, <span class="stringliteral">&quot;&amp;Atilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#195;&quot;</span>, <span class="stringliteral">&quot;&amp;atilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#227;&quot;</span>,
<a name="l00682"></a>00682          <span class="stringliteral">&quot;&amp;Auml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#196;&quot;</span>,   <span class="stringliteral">&quot;&amp;auml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#228;&quot;</span>,   <span class="stringliteral">&quot;&amp;bdquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8222;&quot;</span>,
<a name="l00683"></a>00683          <span class="stringliteral">&quot;&amp;Beta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#914;&quot;</span>,   <span class="stringliteral">&quot;&amp;beta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#946;&quot;</span>,   <span class="stringliteral">&quot;&amp;brvbar;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#166;&quot;</span>,
<a name="l00684"></a>00684          <span class="stringliteral">&quot;&amp;bull;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8226;&quot;</span>,  <span class="stringliteral">&quot;&amp;cap;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8745;&quot;</span>,   <span class="stringliteral">&quot;&amp;Ccedil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#199;&quot;</span>,
<a name="l00685"></a>00685          <span class="stringliteral">&quot;&amp;ccedil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#231;&quot;</span>, <span class="stringliteral">&quot;&amp;cedil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#184;&quot;</span>,  <span class="stringliteral">&quot;&amp;cent;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#162;&quot;</span>,
<a name="l00686"></a>00686          <span class="stringliteral">&quot;&amp;Chi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#935;&quot;</span>, <span class="stringliteral">&quot;&amp;chi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#967;&quot;</span>, <span class="stringliteral">&quot;&amp;circ;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#94;&quot;</span>,
<a name="l00687"></a>00687          <span class="stringliteral">&quot;&amp;clubs;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9827;&quot;</span>, <span class="stringliteral">&quot;&amp;cong;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8773;&quot;</span>,  <span class="stringliteral">&quot;&amp;copy;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#169;&quot;</span>,
<a name="l00688"></a>00688          <span class="stringliteral">&quot;&amp;crarr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8629;&quot;</span>, <span class="stringliteral">&quot;&amp;cup;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8746;&quot;</span>,   <span class="stringliteral">&quot;&amp;curren;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#164;&quot;</span>,
<a name="l00689"></a>00689          <span class="stringliteral">&quot;&amp;dagger;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8224;&quot;</span>,<span class="stringliteral">&quot;&amp;Dagger;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8225;&quot;</span>, <span class="stringliteral">&quot;&amp;darr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8595;&quot;</span>,
<a name="l00690"></a>00690          <span class="stringliteral">&quot;&amp;dArr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8659;&quot;</span>,  <span class="stringliteral">&quot;&amp;deg;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#176;&quot;</span>, <span class="stringliteral">&quot;&amp;Delta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#916;&quot;</span>,
<a name="l00691"></a>00691          <span class="stringliteral">&quot;&amp;delta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#948;&quot;</span>,  <span class="stringliteral">&quot;&amp;diams;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9830;&quot;</span>, <span class="stringliteral">&quot;&amp;divide;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#247;&quot;</span>,
<a name="l00692"></a>00692          <span class="stringliteral">&quot;&amp;Eacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#201;&quot;</span>, <span class="stringliteral">&quot;&amp;eacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#233;&quot;</span>, <span class="stringliteral">&quot;&amp;Ecirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#202;&quot;</span>,
<a name="l00693"></a>00693          <span class="stringliteral">&quot;&amp;ecirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#234;&quot;</span>,  <span class="stringliteral">&quot;&amp;Egrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#200;&quot;</span>, <span class="stringliteral">&quot;&amp;egrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#232;&quot;</span>,
<a name="l00694"></a>00694          <span class="stringliteral">&quot;&amp;empty;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8709;&quot;</span>, <span class="stringliteral">&quot;&amp;emsp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8195;&quot;</span>,  <span class="stringliteral">&quot;&amp;ensp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8194;&quot;</span>,
<a name="l00695"></a>00695          <span class="stringliteral">&quot;&amp;Epsilon;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#917;&quot;</span>,<span class="stringliteral">&quot;&amp;epsilon;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#949;&quot;</span>,<span class="stringliteral">&quot;&amp;equiv;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8801;&quot;</span>,
<a name="l00696"></a>00696          <span class="stringliteral">&quot;&amp;Eta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#919;&quot;</span>, <span class="stringliteral">&quot;&amp;eta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#951;&quot;</span>, <span class="stringliteral">&quot;&amp;ETH;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#208;&quot;</span>,
<a name="l00697"></a>00697          <span class="stringliteral">&quot;&amp;eth;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#240;&quot;</span>, <span class="stringliteral">&quot;&amp;Euml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#203;&quot;</span>,   <span class="stringliteral">&quot;&amp;euml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#235;&quot;</span>,
<a name="l00698"></a>00698          <span class="stringliteral">&quot;&amp;euro;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8364;&quot;</span>,  <span class="stringliteral">&quot;&amp;exist;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8707;&quot;</span>, <span class="stringliteral">&quot;&amp;fnof;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#402;&quot;</span>,
<a name="l00699"></a>00699          <span class="stringliteral">&quot;&amp;forall;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8704;&quot;</span>,<span class="stringliteral">&quot;&amp;frac12;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#189;&quot;</span>, <span class="stringliteral">&quot;&amp;frac14;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#188;&quot;</span>,
<a name="l00700"></a>00700          <span class="stringliteral">&quot;&amp;frac34;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#190;&quot;</span>, <span class="stringliteral">&quot;&amp;frasl;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8260;&quot;</span>, <span class="stringliteral">&quot;&amp;Gamma;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#915;&quot;</span>,
<a name="l00701"></a>00701          <span class="stringliteral">&quot;&amp;gamma;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#947;&quot;</span>,  <span class="stringliteral">&quot;&amp;ge;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8805;&quot;</span>, <span class="stringliteral">&quot;&amp;gt;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#62;&quot;</span>,
<a name="l00702"></a>00702          <span class="stringliteral">&quot;&amp;harr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8596;&quot;</span>,  <span class="stringliteral">&quot;&amp;hArr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8660;&quot;</span>,  <span class="stringliteral">&quot;&amp;hearts;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9829;&quot;</span>,
<a name="l00703"></a>00703          <span class="stringliteral">&quot;&amp;hellip;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8230;&quot;</span>,<span class="stringliteral">&quot;&amp;Iacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#205;&quot;</span>, <span class="stringliteral">&quot;&amp;iacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#237;&quot;</span>,
<a name="l00704"></a>00704          <span class="stringliteral">&quot;&amp;Icirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#206;&quot;</span>,  <span class="stringliteral">&quot;&amp;icirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#238;&quot;</span>,  <span class="stringliteral">&quot;&amp;iexcl;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#161;&quot;</span>,
<a name="l00705"></a>00705          <span class="stringliteral">&quot;&amp;Igrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#204;&quot;</span>, <span class="stringliteral">&quot;&amp;igrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#236;&quot;</span>, <span class="stringliteral">&quot;&amp;image;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8465;&quot;</span>,
<a name="l00706"></a>00706          <span class="stringliteral">&quot;&amp;infin;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8734;&quot;</span>, <span class="stringliteral">&quot;&amp;int;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8747;&quot;</span>,   <span class="stringliteral">&quot;&amp;Iota;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#921;&quot;</span>,
<a name="l00707"></a>00707          <span class="stringliteral">&quot;&amp;iota;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#953;&quot;</span>,   <span class="stringliteral">&quot;&amp;iquest;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#191;&quot;</span>, <span class="stringliteral">&quot;&amp;isin;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8712;&quot;</span>,
<a name="l00708"></a>00708          <span class="stringliteral">&quot;&amp;Iuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#207;&quot;</span>,   <span class="stringliteral">&quot;&amp;iuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#239;&quot;</span>,   <span class="stringliteral">&quot;&amp;Kappa;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#922;&quot;</span>,
<a name="l00709"></a>00709          <span class="stringliteral">&quot;&amp;kappa;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#954;&quot;</span>,  <span class="stringliteral">&quot;&amp;Lambda;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#923;&quot;</span>, <span class="stringliteral">&quot;&amp;lambda;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#955;&quot;</span>,
<a name="l00710"></a>00710          <span class="stringliteral">&quot;&amp;lang;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9001;&quot;</span>,  <span class="stringliteral">&quot;&amp;laquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#171;&quot;</span>,  <span class="stringliteral">&quot;&amp;larr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8592;&quot;</span>,
<a name="l00711"></a>00711          <span class="stringliteral">&quot;&amp;lArr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8656;&quot;</span>,  <span class="stringliteral">&quot;&amp;lceil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8968;&quot;</span>,
<a name="l00712"></a>00712          <span class="stringliteral">&quot;&amp;ldquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8220;&quot;</span>, <span class="stringliteral">&quot;&amp;le;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8804;&quot;</span>, <span class="stringliteral">&quot;&amp;lfloor;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8970;&quot;</span>,
<a name="l00713"></a>00713          <span class="stringliteral">&quot;&amp;lowast;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8727;&quot;</span>,<span class="stringliteral">&quot;&amp;loz;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9674;&quot;</span>,   <span class="stringliteral">&quot;&amp;lrm;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8206;&quot;</span>,
<a name="l00714"></a>00714          <span class="stringliteral">&quot;&amp;lsaquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8249;&quot;</span>,<span class="stringliteral">&quot;&amp;lsquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8216;&quot;</span>, <span class="stringliteral">&quot;&amp;lt;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#60;&quot;</span>,
<a name="l00715"></a>00715          <span class="stringliteral">&quot;&amp;macr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#175;&quot;</span>,   <span class="stringliteral">&quot;&amp;mdash;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8212;&quot;</span>, <span class="stringliteral">&quot;&amp;micro;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#181;&quot;</span>,
<a name="l00716"></a>00716          <span class="stringliteral">&quot;&amp;middot;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#183;&quot;</span>, <span class="stringliteral">&quot;&amp;minus;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#45;&quot;</span>,   <span class="stringliteral">&quot;&amp;Mu;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#924;&quot;</span>,
<a name="l00717"></a>00717          <span class="stringliteral">&quot;&amp;mu;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#956;&quot;</span>,  <span class="stringliteral">&quot;&amp;nabla;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8711;&quot;</span>, <span class="stringliteral">&quot;&amp;nbsp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#160;&quot;</span>,
<a name="l00718"></a>00718          <span class="stringliteral">&quot;&amp;ndash;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8211;&quot;</span>, <span class="stringliteral">&quot;&amp;ne;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8800;&quot;</span>, <span class="stringliteral">&quot;&amp;ni;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8715;&quot;</span>,
<a name="l00719"></a>00719          <span class="stringliteral">&quot;&amp;not;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#172;&quot;</span>, <span class="stringliteral">&quot;&amp;notin;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8713;&quot;</span>, <span class="stringliteral">&quot;&amp;nsub;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8836;&quot;</span>,
<a name="l00720"></a>00720          <span class="stringliteral">&quot;&amp;Ntilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#209;&quot;</span>, <span class="stringliteral">&quot;&amp;ntilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#241;&quot;</span>, <span class="stringliteral">&quot;&amp;Nu;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#925;&quot;</span>,
<a name="l00721"></a>00721          <span class="stringliteral">&quot;&amp;nu;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#957;&quot;</span>,  <span class="stringliteral">&quot;&amp;Oacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#211;&quot;</span>, <span class="stringliteral">&quot;&amp;oacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#243;&quot;</span>,
<a name="l00722"></a>00722          <span class="stringliteral">&quot;&amp;Ocirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#212;&quot;</span>,  <span class="stringliteral">&quot;&amp;ocirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#244;&quot;</span>,  <span class="stringliteral">&quot;&amp;OElig;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#338;&quot;</span>,
<a name="l00723"></a>00723          <span class="stringliteral">&quot;&amp;oelig;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#339;&quot;</span>,  <span class="stringliteral">&quot;&amp;Ograve;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#210;&quot;</span>, <span class="stringliteral">&quot;&amp;ograve;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#242;&quot;</span>,
<a name="l00724"></a>00724          <span class="stringliteral">&quot;&amp;oline;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8254;&quot;</span>, <span class="stringliteral">&quot;&amp;Omega;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#937;&quot;</span>,  <span class="stringliteral">&quot;&amp;omega;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#969;&quot;</span>,
<a name="l00725"></a>00725          <span class="stringliteral">&quot;&amp;Omicron;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#927;&quot;</span>,<span class="stringliteral">&quot;&amp;omicron;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#959;&quot;</span>,<span class="stringliteral">&quot;&amp;oplus;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8853;&quot;</span>,
<a name="l00726"></a>00726          <span class="stringliteral">&quot;&amp;or;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8744;&quot;</span>, <span class="stringliteral">&quot;&amp;ordf;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#170;&quot;</span>,   <span class="stringliteral">&quot;&amp;ordm;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#186;&quot;</span>,
<a name="l00727"></a>00727          <span class="stringliteral">&quot;&amp;Oslash;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#216;&quot;</span>, <span class="stringliteral">&quot;&amp;oslash;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#248;&quot;</span>, <span class="stringliteral">&quot;&amp;Otilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#213;&quot;</span>,
<a name="l00728"></a>00728          <span class="stringliteral">&quot;&amp;otilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#245;&quot;</span>, <span class="stringliteral">&quot;&amp;otimes;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8855;&quot;</span>,<span class="stringliteral">&quot;&amp;Ouml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#214;&quot;</span>,
<a name="l00729"></a>00729          <span class="stringliteral">&quot;&amp;ouml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#246;&quot;</span>,   <span class="stringliteral">&quot;&amp;para;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#182;&quot;</span>,   <span class="stringliteral">&quot;&amp;part;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8706;&quot;</span>,
<a name="l00730"></a>00730          <span class="stringliteral">&quot;&amp;permil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8240;&quot;</span>,<span class="stringliteral">&quot;&amp;perp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8869;&quot;</span>,  <span class="stringliteral">&quot;&amp;Phi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#934;&quot;</span>,
<a name="l00731"></a>00731          <span class="stringliteral">&quot;&amp;phi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#966;&quot;</span>, <span class="stringliteral">&quot;&amp;Pi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#928;&quot;</span>,  <span class="stringliteral">&quot;&amp;pi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#960;&quot;</span>,
<a name="l00732"></a>00732          <span class="stringliteral">&quot;&amp;piv;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#982;&quot;</span>, <span class="stringliteral">&quot;&amp;plusmn;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#177;&quot;</span>, <span class="stringliteral">&quot;&amp;pound;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#163;&quot;</span>,
<a name="l00733"></a>00733          <span class="stringliteral">&quot;&amp;prime;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8242;&quot;</span>, <span class="stringliteral">&quot;&amp;Prime;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8243;&quot;</span>, <span class="stringliteral">&quot;&amp;prod;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8719;&quot;</span>,
<a name="l00734"></a>00734          <span class="stringliteral">&quot;&amp;prop;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8733;&quot;</span>,  <span class="stringliteral">&quot;&amp;Psi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#936;&quot;</span>, <span class="stringliteral">&quot;&amp;psi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#968;&quot;</span>,
<a name="l00735"></a>00735          <span class="stringliteral">&quot;&amp;quot;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#34;&quot;</span>, <span class="stringliteral">&quot;&amp;radic;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8730;&quot;</span>, <span class="stringliteral">&quot;&amp;rang;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9002;&quot;</span>,
<a name="l00736"></a>00736          <span class="stringliteral">&quot;&amp;raquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#187;&quot;</span>,  <span class="stringliteral">&quot;&amp;rarr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8594;&quot;</span>,  <span class="stringliteral">&quot;&amp;rArr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8658;&quot;</span>,
<a name="l00737"></a>00737          <span class="stringliteral">&quot;&amp;rceil;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8969;&quot;</span>, <span class="stringliteral">&quot;&amp;rdquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8221;&quot;</span>, <span class="stringliteral">&quot;&amp;real;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8476;&quot;</span>,
<a name="l00738"></a>00738          <span class="stringliteral">&quot;&amp;reg;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#174;&quot;</span>, <span class="stringliteral">&quot;&amp;rfloor;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8971;&quot;</span>,<span class="stringliteral">&quot;&amp;Rho;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#929;&quot;</span>,
<a name="l00739"></a>00739          <span class="stringliteral">&quot;&amp;rho;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#961;&quot;</span>, <span class="stringliteral">&quot;&amp;rlm;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8207;&quot;</span>,   <span class="stringliteral">&quot;&amp;rsaquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8250;&quot;</span>,
<a name="l00740"></a>00740          <span class="stringliteral">&quot;&amp;rsquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8217;&quot;</span>, <span class="stringliteral">&quot;&amp;sbquo;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8218;&quot;</span>, <span class="stringliteral">&quot;&amp;Scaron;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#352;&quot;</span>,
<a name="l00741"></a>00741          <span class="stringliteral">&quot;&amp;scaron;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#353;&quot;</span>, <span class="stringliteral">&quot;&amp;sdot;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8901;&quot;</span>,  <span class="stringliteral">&quot;&amp;sect;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#167;&quot;</span>,
<a name="l00742"></a>00742          <span class="stringliteral">&quot;&amp;shy;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#173;&quot;</span>, <span class="stringliteral">&quot;&amp;Sigma;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#931;&quot;</span>,  <span class="stringliteral">&quot;&amp;sigma;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#963;&quot;</span>,
<a name="l00743"></a>00743          <span class="stringliteral">&quot;&amp;sigmaf;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#962;&quot;</span>, <span class="stringliteral">&quot;&amp;sim;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8764;&quot;</span>,   <span class="stringliteral">&quot;&amp;spades;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#9824;&quot;</span>,
<a name="l00744"></a>00744          <span class="stringliteral">&quot;&amp;sub;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8834;&quot;</span>,   <span class="stringliteral">&quot;&amp;sube;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8838;&quot;</span>,  <span class="stringliteral">&quot;&amp;sum;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8721;&quot;</span>,
<a name="l00745"></a>00745          <span class="stringliteral">&quot;&amp;sup1;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#185;&quot;</span>,   <span class="stringliteral">&quot;&amp;sup2;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#178;&quot;</span>,   <span class="stringliteral">&quot;&amp;sup3;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#179;&quot;</span>,
<a name="l00746"></a>00746          <span class="stringliteral">&quot;&amp;sup;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8835;&quot;</span>,   <span class="stringliteral">&quot;&amp;supe;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8839;&quot;</span>,  <span class="stringliteral">&quot;&amp;szlig;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#223;&quot;</span>,
<a name="l00747"></a>00747          <span class="stringliteral">&quot;&amp;Tau;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#932;&quot;</span>, <span class="stringliteral">&quot;&amp;tau;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#964;&quot;</span>, <span class="stringliteral">&quot;&amp;there4;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8756;&quot;</span>,
<a name="l00748"></a>00748          <span class="stringliteral">&quot;&amp;Theta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#920;&quot;</span>,  <span class="stringliteral">&quot;&amp;theta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#952;&quot;</span>,  <span class="stringliteral">&quot;&amp;thetasym;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#977;&quot;</span>,
<a name="l00749"></a>00749          <span class="stringliteral">&quot;&amp;thinsp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8201;&quot;</span>,<span class="stringliteral">&quot;&amp;THORN;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#222;&quot;</span>,  <span class="stringliteral">&quot;&amp;thorn;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#254;&quot;</span>,
<a name="l00750"></a>00750          <span class="stringliteral">&quot;&amp;tilde;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#126;&quot;</span>,  <span class="stringliteral">&quot;&amp;times;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#215;&quot;</span>,  <span class="stringliteral">&quot;&amp;trade;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8482;&quot;</span>,
<a name="l00751"></a>00751          <span class="stringliteral">&quot;&amp;Uacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#218;&quot;</span>, <span class="stringliteral">&quot;&amp;uacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#250;&quot;</span>, <span class="stringliteral">&quot;&amp;uarr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8593;&quot;</span>,
<a name="l00752"></a>00752          <span class="stringliteral">&quot;&amp;uArr;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8657;&quot;</span>,  <span class="stringliteral">&quot;&amp;Ucirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#219;&quot;</span>,  <span class="stringliteral">&quot;&amp;ucirc;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#251;&quot;</span>,
<a name="l00753"></a>00753          <span class="stringliteral">&quot;&amp;Ugrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#217;&quot;</span>, <span class="stringliteral">&quot;&amp;ugrave;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#249;&quot;</span>, <span class="stringliteral">&quot;&amp;uml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#168;&quot;</span>,
<a name="l00754"></a>00754          <span class="stringliteral">&quot;&amp;upsih;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#978;&quot;</span>,  <span class="stringliteral">&quot;&amp;Upsilon;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#933;&quot;</span>,<span class="stringliteral">&quot;&amp;upsilon;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#965;&quot;</span>,
<a name="l00755"></a>00755          <span class="stringliteral">&quot;&amp;Uuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#220;&quot;</span>,   <span class="stringliteral">&quot;&amp;uuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#252;&quot;</span>,   <span class="stringliteral">&quot;&amp;weierp;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8472;&quot;</span>,
<a name="l00756"></a>00756          <span class="stringliteral">&quot;&amp;Xi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#926;&quot;</span>,  <span class="stringliteral">&quot;&amp;xi;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#958;&quot;</span>,  <span class="stringliteral">&quot;&amp;Yacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#221;&quot;</span>,
<a name="l00757"></a>00757          <span class="stringliteral">&quot;&amp;yacute;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#253;&quot;</span>, <span class="stringliteral">&quot;&amp;yen;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#165;&quot;</span>, <span class="stringliteral">&quot;&amp;yuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#255;&quot;</span>,
<a name="l00758"></a>00758          <span class="stringliteral">&quot;&amp;Yuml;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#376;&quot;</span>,   <span class="stringliteral">&quot;&amp;Zeta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#918;&quot;</span>,   <span class="stringliteral">&quot;&amp;zeta;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#950;&quot;</span>,
<a name="l00759"></a>00759          <span class="stringliteral">&quot;&amp;zwj;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8205;&quot;</span>,   <span class="stringliteral">&quot;&amp;zwnj;&quot;</span> =&gt; <span class="stringliteral">&quot;&amp;#8204;&quot;</span>
<a name="l00760"></a>00760       );
<a name="l00761"></a>00761 
<a name="l00762"></a>00762       <span class="keywordflow">return</span> $html_entities;
<a name="l00763"></a>00763    }
<a name="l00764"></a>00764 <span class="comment"></span>
<a name="l00765"></a>00765 <span class="comment">   /**</span>
<a name="l00766"></a>00766 <span class="comment">    * Wrapper around fputcsv for systems that may or may not support it</span>
<a name="l00767"></a>00767 <span class="comment">    * (i.e. PHP before 5.1.0); see PHP documentation for fputcsv.</span>
<a name="l00768"></a><a class="code" href="class_string.html#ad2a1657f11d36395f0b9992390272db4">00768</a> <span class="comment">    */</span>
<a name="l00769"></a>00769    <span class="keyword">function</span> <a class="code" href="class_string.html#ad2a1657f11d36395f0b9992390272db4">fputcsv</a>(&amp;$handle, $fields = array(), $delimiter = <span class="charliteral">&#39;,&#39;</span>, $enclosure = <span class="charliteral">&#39;&quot;&#39;</span>) {
<a name="l00770"></a>00770       <span class="comment">// From PHP website, thanks to boefje at hotmail dot com</span>
<a name="l00771"></a>00771       <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;fputcsv&#39;</span>)) {
<a name="l00772"></a>00772          <span class="keywordflow">return</span> <a class="code" href="class_string.html#ad2a1657f11d36395f0b9992390272db4">fputcsv</a>($handle, $fields, $delimiter, $enclosure);
<a name="l00773"></a>00773       }
<a name="l00774"></a>00774       $str = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00775"></a>00775       $escape_char = <span class="charliteral">&#39;\\&#39;</span>;
<a name="l00776"></a>00776       <span class="keywordflow">foreach</span> ($fields as $value) {
<a name="l00777"></a>00777          <span class="keywordflow">if</span> (  <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, $delimiter) !== <span class="keyword">false</span> ||
<a name="l00778"></a>00778             <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, $enclosure) !== <span class="keyword">false</span> ||
<a name="l00779"></a>00779             <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, <span class="stringliteral">&quot;\n&quot;</span>) !== <span class="keyword">false</span> ||
<a name="l00780"></a>00780             <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, <span class="stringliteral">&quot;\r&quot;</span>) !== <span class="keyword">false</span> ||
<a name="l00781"></a>00781             <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, <span class="stringliteral">&quot;\t&quot;</span>) !== <span class="keyword">false</span> ||
<a name="l00782"></a>00782             <a class="code" href="class_string.html#a75b50139ee3829fbfd47af6805284786">strpos</a>($value, <span class="charliteral">&#39; &#39;</span>) !== <span class="keyword">false</span>
<a name="l00783"></a>00783          ) {
<a name="l00784"></a>00784             $str2 = $enclosure;
<a name="l00785"></a>00785             $escaped = 0;
<a name="l00786"></a>00786             $len = <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>($value);
<a name="l00787"></a>00787             <span class="keywordflow">for</span> ($i=0; $i&lt;$len; $i++) {
<a name="l00788"></a>00788                <span class="keywordflow">if</span> ($value[$i] == $escape_char) $escaped = 1;
<a name="l00789"></a>00789                elseif (!$escaped &amp;&amp; $value[$i] == $enclosure) $str2 .= $enclosure;
<a name="l00790"></a>00790                <span class="keywordflow">else</span> $escaped = 0;
<a name="l00791"></a>00791                $str2 .= $value[$i];
<a name="l00792"></a>00792             }
<a name="l00793"></a>00793             $str2 .= $enclosure;
<a name="l00794"></a>00794             $str .= $str2 . $delimiter;
<a name="l00795"></a>00795          } <span class="keywordflow">else</span> {
<a name="l00796"></a>00796             $str .= $value . $delimiter;
<a name="l00797"></a>00797          }
<a name="l00798"></a>00798       }
<a name="l00799"></a>00799       $str = <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($str, 0, -1);
<a name="l00800"></a>00800       $str .= <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00801"></a>00801       <span class="keywordflow">return</span> fwrite($handle, $str);
<a name="l00802"></a>00802    }
<a name="l00803"></a>00803 <span class="comment"></span>
<a name="l00804"></a>00804 <span class="comment">   /**</span>
<a name="l00805"></a>00805 <span class="comment">    * Trim punctuation from a string</span>
<a name="l00806"></a>00806 <span class="comment">    * @param $string string input string</span>
<a name="l00807"></a>00807 <span class="comment">    * @return string the trimmed string</span>
<a name="l00808"></a><a class="code" href="class_string.html#ad6c1fd62c4e46145f5acf940dc274ec1">00808</a> <span class="comment">    */</span>
<a name="l00809"></a>00809    <span class="keyword">function</span> <a class="code" href="class_string.html#ad6c1fd62c4e46145f5acf940dc274ec1">trimPunctuation</a>($string) {
<a name="l00810"></a>00810       <span class="keywordflow">return</span> trim($string, <span class="stringliteral">&#39; ,.;:!?&amp;()[]\\/&#39;</span>);
<a name="l00811"></a>00811    }
<a name="l00812"></a>00812 <span class="comment"></span>
<a name="l00813"></a>00813 <span class="comment">   /**</span>
<a name="l00814"></a>00814 <span class="comment">    * Convert a string to proper title case</span>
<a name="l00815"></a>00815 <span class="comment">    * @param $title string</span>
<a name="l00816"></a>00816 <span class="comment">    * @return string</span>
<a name="l00817"></a><a class="code" href="class_string.html#ab79f3e83d723661923d45f30c69e2851">00817</a> <span class="comment">    */</span>
<a name="l00818"></a>00818    <span class="keyword">function</span> <a class="code" href="class_string.html#ab79f3e83d723661923d45f30c69e2851">titleCase</a>($title) {
<a name="l00819"></a>00819       $smallWords = array(
<a name="l00820"></a>00820          <span class="stringliteral">&#39;of&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="stringliteral">&#39;the&#39;</span>, <span class="stringliteral">&#39;and&#39;</span>, <span class="stringliteral">&#39;an&#39;</span>, <span class="stringliteral">&#39;or&#39;</span>, <span class="stringliteral">&#39;nor&#39;</span>, <span class="stringliteral">&#39;but&#39;</span>, <span class="stringliteral">&#39;is&#39;</span>, <span class="stringliteral">&#39;if&#39;</span>, <span class="stringliteral">&#39;then&#39;</span>,
<a name="l00821"></a>00821          <span class="stringliteral">&#39;else&#39;</span>, <span class="stringliteral">&#39;when&#39;</span>, <span class="stringliteral">&#39;at&#39;</span>, <span class="stringliteral">&#39;from&#39;</span>, <span class="stringliteral">&#39;by&#39;</span>, <span class="stringliteral">&#39;on&#39;</span>, <span class="stringliteral">&#39;off&#39;</span>, <span class="stringliteral">&#39;for&#39;</span>, <span class="stringliteral">&#39;in&#39;</span>, <span class="stringliteral">&#39;out&#39;</span>,
<a name="l00822"></a>00822          <span class="stringliteral">&#39;over&#39;</span>, <span class="stringliteral">&#39;to&#39;</span>, <span class="stringliteral">&#39;into&#39;</span>, <span class="stringliteral">&#39;with&#39;</span>
<a name="l00823"></a>00823       );
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       $words = explode(<span class="charliteral">&#39; &#39;</span>, $title);
<a name="l00826"></a>00826       <span class="keywordflow">foreach</span> ($words as $key =&gt; $word) {
<a name="l00827"></a>00827          <span class="keywordflow">if</span> ($key == 0 or !in_array(<a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">String::strtolower</a>($word), $smallWords)) {
<a name="l00828"></a>00828             $words[$key] = <a class="code" href="class_string.html#a3b164a986c30df6ce7be062dc2c4d771">ucfirst</a>(<a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">String::strtolower</a>($word));
<a name="l00829"></a>00829          } <span class="keywordflow">else</span> {
<a name="l00830"></a>00830             $words[$key] = <a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">String::strtolower</a>($word);
<a name="l00831"></a>00831          }
<a name="l00832"></a>00832       }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834       $newTitle = implode(<span class="charliteral">&#39; &#39;</span>, $words);
<a name="l00835"></a>00835       <span class="keywordflow">return</span> $newTitle;
<a name="l00836"></a>00836    }
<a name="l00837"></a>00837 <span class="comment"></span>
<a name="l00838"></a>00838 <span class="comment">   /**</span>
<a name="l00839"></a>00839 <span class="comment">    * Iterate over an array of delimiters and see whether</span>
<a name="l00840"></a>00840 <span class="comment">    * it exists in the given input string. If so, then use</span>
<a name="l00841"></a>00841 <span class="comment">    * it to explode the string into an array.</span>
<a name="l00842"></a>00842 <span class="comment">    * @param $delimiters array</span>
<a name="l00843"></a>00843 <span class="comment">    * @param $input string</span>
<a name="l00844"></a>00844 <span class="comment">    * @return array</span>
<a name="l00845"></a><a class="code" href="class_string.html#a055fc6e0d34b7ce1ddf3181fbbe2d2d4">00845</a> <span class="comment">    */</span>
<a name="l00846"></a>00846    <span class="keyword">function</span> <a class="code" href="class_string.html#a055fc6e0d34b7ce1ddf3181fbbe2d2d4">iterativeExplode</a>($delimiters, $input) {
<a name="l00847"></a>00847       <span class="comment">// Run through the delimiters and try them out</span>
<a name="l00848"></a>00848       <span class="comment">// one by one.</span>
<a name="l00849"></a>00849       <span class="keywordflow">foreach</span>($delimiters as $delimiter) {
<a name="l00850"></a>00850          <span class="keywordflow">if</span> (strstr($input, $delimiter) !== <span class="keyword">false</span>) {
<a name="l00851"></a>00851             <span class="keywordflow">return</span> explode($delimiter, $input);
<a name="l00852"></a>00852          }
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855       <span class="comment">// If none of the delimiters works then return</span>
<a name="l00856"></a>00856       <span class="comment">// the original string as an array.</span>
<a name="l00857"></a>00857       <span class="keywordflow">return</span> (array($input));
<a name="l00858"></a>00858    }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment">   /**</span>
<a name="l00863"></a>00863 <span class="comment">    * Transform &quot;handler-class&quot; to &quot;HandlerClass&quot;</span>
<a name="l00864"></a>00864 <span class="comment">    * and &quot;my-op&quot; to &quot;myOp&quot;.</span>
<a name="l00865"></a>00865 <span class="comment">    * @param $string input string</span>
<a name="l00866"></a>00866 <span class="comment">    * @param $type which kind of camel case?</span>
<a name="l00867"></a>00867 <span class="comment">    * @return string the string in camel case</span>
<a name="l00868"></a><a class="code" href="class_string.html#acd23b7025d8640a83033a317ff59956d">00868</a> <span class="comment">    */</span>
<a name="l00869"></a>00869    <span class="keyword">function</span> <a class="code" href="class_string.html#acd23b7025d8640a83033a317ff59956d">camelize</a>($string, $type = CAMEL_CASE_HEAD_UP) {
<a name="l00870"></a>00870       assert($type == CAMEL_CASE_HEAD_UP || $type == CAMEL_CASE_HEAD_DOWN);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       <span class="comment">// Transform &quot;handler-class&quot; to &quot;HandlerClass&quot; and &quot;my-op&quot; to &quot;MyOp&quot;</span>
<a name="l00873"></a>00873       $string = str_replace(<span class="charliteral">&#39; &#39;</span>, <span class="stringliteral">&#39;&#39;</span>, ucwords(str_replace(<span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39; &#39;</span>, $string)));
<a name="l00874"></a>00874 
<a name="l00875"></a>00875       <span class="comment">// Transform &quot;MyOp&quot; to &quot;myOp&quot;</span>
<a name="l00876"></a>00876       <span class="keywordflow">if</span> ($type == CAMEL_CASE_HEAD_DOWN) {
<a name="l00877"></a>00877          <span class="comment">// lcfirst() is PHP&gt;5.3, so use workaround for PHP4 compatibility</span>
<a name="l00878"></a>00878          $string = <a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">strtolower</a>(<a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">substr</a>($string, 0, 1)).substr($string, 1);
<a name="l00879"></a>00879       }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881       <span class="keywordflow">return</span> $string;
<a name="l00882"></a>00882    }
<a name="l00883"></a>00883 <span class="comment"></span>
<a name="l00884"></a>00884 <span class="comment">   /**</span>
<a name="l00885"></a>00885 <span class="comment">    * Transform &quot;HandlerClass&quot; to &quot;handler-class&quot;</span>
<a name="l00886"></a>00886 <span class="comment">    * and &quot;myOp&quot; to &quot;my-op&quot;.</span>
<a name="l00887"></a>00887 <span class="comment">    * @param $string</span>
<a name="l00888"></a><a class="code" href="class_string.html#a0942cb40ca0c6ba360f3fbd66661a3de">00888</a> <span class="comment">    */</span>
<a name="l00889"></a>00889    <span class="keyword">function</span> <a class="code" href="class_string.html#a0942cb40ca0c6ba360f3fbd66661a3de">uncamelize</a>($string) {
<a name="l00890"></a>00890       assert(!empty($string));
<a name="l00891"></a>00891 
<a name="l00892"></a>00892       <span class="comment">// Transform &quot;myOp&quot; to &quot;MyOp&quot;</span>
<a name="l00893"></a>00893       $string = <a class="code" href="class_string.html#a3b164a986c30df6ce7be062dc2c4d771">ucfirst</a>($string);
<a name="l00894"></a>00894 
<a name="l00895"></a>00895       <span class="comment">// Insert hyphens between words and return the string in lowercase</span>
<a name="l00896"></a>00896       $words = array();
<a name="l00897"></a>00897       <a class="code" href="class_string.html#a931743bdcd61c0c239f4cade66b7f262">String::regexp_match_all</a>(<span class="stringliteral">&#39;/[A-Z][a-z0-9]*/&#39;</span>, $string, $words);
<a name="l00898"></a>00898       assert(isset($words[0]) &amp;&amp; !empty($words[0]) &amp;&amp; <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>(implode(<span class="stringliteral">&#39;&#39;</span>, $words[0])) == <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">strlen</a>($string));
<a name="l00899"></a>00899       <span class="keywordflow">return</span> <a class="code" href="class_string.html#ac1a7d60b7ef7b735e08b2ba85dce844f">strtolower</a>(implode(<span class="charliteral">&#39;-&#39;</span>, $words[0]));
<a name="l00900"></a>00900    }
<a name="l00901"></a>00901 <span class="comment"></span>
<a name="l00902"></a>00902 <span class="comment">   /**</span>
<a name="l00903"></a>00903 <span class="comment">    * Calculate the differences between two strings and</span>
<a name="l00904"></a>00904 <span class="comment">    * produce an array with three types of entries: added</span>
<a name="l00905"></a>00905 <span class="comment">    * substrings, deleted substrings and unchanged substrings.</span>
<a name="l00906"></a>00906 <span class="comment">    *</span>
<a name="l00907"></a>00907 <span class="comment">    * The calculation is optimized to identify the common</span>
<a name="l00908"></a>00908 <span class="comment">    * largest substring.</span>
<a name="l00909"></a>00909 <span class="comment">    *</span>
<a name="l00910"></a>00910 <span class="comment">    * The return value is an array of the following format:</span>
<a name="l00911"></a>00911 <span class="comment">    *</span>
<a name="l00912"></a>00912 <span class="comment">    * array(</span>
<a name="l00913"></a>00913 <span class="comment">    *   array( diff-type =&gt; substring ),</span>
<a name="l00914"></a>00914 <span class="comment">    *   array(...)</span>
<a name="l00915"></a>00915 <span class="comment">    * )</span>
<a name="l00916"></a>00916 <span class="comment">    *</span>
<a name="l00917"></a>00917 <span class="comment">    * whereby diff-type can be one of:</span>
<a name="l00918"></a>00918 <span class="comment">    *   -1 = deletion</span>
<a name="l00919"></a>00919 <span class="comment">    *    0 = common substring</span>
<a name="l00920"></a>00920 <span class="comment">    *    1 = addition</span>
<a name="l00921"></a>00921 <span class="comment">    *</span>
<a name="l00922"></a>00922 <span class="comment">    * @param $string1 string</span>
<a name="l00923"></a>00923 <span class="comment">    * @param $string2 string</span>
<a name="l00924"></a>00924 <span class="comment">    * @return array</span>
<a name="l00925"></a><a class="code" href="class_string.html#a52e328b071450a7c9f3a041ac70f41ca">00925</a> <span class="comment">    */</span>
<a name="l00926"></a>00926    <span class="keyword">function</span> <a class="code" href="class_string.html#a52e328b071450a7c9f3a041ac70f41ca">diff</a>($originalString, $editedString) {
<a name="l00927"></a>00927       <span class="comment">// Split strings into character arrays (multi-byte compatible).</span>
<a name="l00928"></a>00928       <span class="keywordflow">foreach</span>(array(<span class="stringliteral">&#39;originalStringCharacters&#39;</span> =&gt; $originalString, <span class="stringliteral">&#39;editedStringCharacters&#39;</span> =&gt; $editedString) as $characterArrayName =&gt; $string) {
<a name="l00929"></a>00929          ${$characterArrayName} = array();
<a name="l00930"></a>00930          <a class="code" href="class_string.html#a931743bdcd61c0c239f4cade66b7f262">String::regexp_match_all</a>(<span class="stringliteral">&#39;/./&#39;</span>, $string, ${$characterArrayName});
<a name="l00931"></a>00931          <span class="keywordflow">if</span> (isset(${$characterArrayName}[0])) {
<a name="l00932"></a>00932             ${$characterArrayName} = ${$characterArrayName}[0];
<a name="l00933"></a>00933          }
<a name="l00934"></a>00934       }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936       <span class="comment">// Determine the length of the strings.</span>
<a name="l00937"></a>00937       $originalStringLength = count($originalStringCharacters);
<a name="l00938"></a>00938       $editedStringLength = count($editedStringCharacters);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       <span class="comment">// Is there anything to compare?</span>
<a name="l00941"></a>00941       <span class="keywordflow">if</span> ($originalStringLength == 0 &amp;&amp; $editedStringLength == 0) <span class="keywordflow">return</span> array();
<a name="l00942"></a>00942 
<a name="l00943"></a>00943       <span class="comment">// Is the original string empty?</span>
<a name="l00944"></a>00944       <span class="keywordflow">if</span> ($originalStringLength == 0) {
<a name="l00945"></a>00945          <span class="comment">// Return the edited string as addition.</span>
<a name="l00946"></a>00946          <span class="keywordflow">return</span> array(array(1 =&gt; $editedString));
<a name="l00947"></a>00947       }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949       <span class="comment">// Is the edited string empty?</span>
<a name="l00950"></a>00950       <span class="keywordflow">if</span> ($editedStringLength == 0) {
<a name="l00951"></a>00951          <span class="comment">// Return the original string as deletion.</span>
<a name="l00952"></a>00952          <span class="keywordflow">return</span> array(array(-1 =&gt; $originalString));
<a name="l00953"></a>00953       }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955       <span class="comment">// Initialize the local indices:</span>
<a name="l00956"></a>00956       <span class="comment">// 1) Create a character index for the edited string.</span>
<a name="l00957"></a>00957       $characterIndex = array();
<a name="l00958"></a>00958       <span class="keywordflow">for</span>($characterPosition = 0; $characterPosition &lt; $editedStringLength; $characterPosition++) {
<a name="l00959"></a>00959          $characterIndex[$editedStringCharacters[$characterPosition]][] = $characterPosition;
<a name="l00960"></a>00960       }
<a name="l00961"></a>00961       <span class="comment">// 2) Initialize the substring and the length index.</span>
<a name="l00962"></a>00962       $substringIndex = $lengthIndex = array();
<a name="l00963"></a>00963 
<a name="l00964"></a>00964       <span class="comment">// Iterate over the original string to identify</span>
<a name="l00965"></a>00965       <span class="comment">// the largest common string.</span>
<a name="l00966"></a>00966       <span class="keywordflow">for</span>($originalPosition = 0; $originalPosition &lt; $originalStringLength; $originalPosition++) {
<a name="l00967"></a>00967          <span class="comment">// Find all occurrences of the original character</span>
<a name="l00968"></a>00968          <span class="comment">// in the target string.</span>
<a name="l00969"></a>00969          $comparedCharacter = $originalStringCharacters[$originalPosition];
<a name="l00970"></a>00970 
<a name="l00971"></a>00971          <span class="comment">// Do we have a commonality between the original string</span>
<a name="l00972"></a>00972          <span class="comment">// and the edited string?</span>
<a name="l00973"></a>00973          <span class="keywordflow">if</span> (isset($characterIndex[$comparedCharacter])) {
<a name="l00974"></a>00974             <span class="comment">// Loop over all commonalities.</span>
<a name="l00975"></a>00975             <span class="keywordflow">foreach</span>($characterIndex[$comparedCharacter] as $editedPosition) {
<a name="l00976"></a>00976                <span class="comment">// Calculate the current and the preceding position</span>
<a name="l00977"></a>00977                <span class="comment">// ids for indexation.</span>
<a name="l00978"></a>00978                $currentPosition = $originalPosition . <span class="charliteral">&#39;-&#39;</span> . $editedPosition;
<a name="l00979"></a>00979                $previousPosition = ($originalPosition-1) . <span class="charliteral">&#39;-&#39;</span> . ($editedPosition-1);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981                <span class="comment">// Does the occurrence in the target string continue</span>
<a name="l00982"></a>00982                <span class="comment">// an existing common substring or does it start</span>
<a name="l00983"></a>00983                <span class="comment">// a new one?</span>
<a name="l00984"></a>00984                <span class="keywordflow">if</span> (isset($substringIndex[$previousPosition])) {
<a name="l00985"></a>00985                   <span class="comment">// This is a continuation of an existing common</span>
<a name="l00986"></a>00986                   <span class="comment">// substring...</span>
<a name="l00987"></a>00987                   $newSubstring = $substringIndex[$previousPosition].$comparedCharacter;
<a name="l00988"></a>00988                   $newSubstringLength = <a class="code" href="class_string.html#aa280f76645efe62221dc1348ebbbbd26">String::strlen</a>($newSubstring);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                   <span class="comment">// Move the substring in the substring index.</span>
<a name="l00991"></a>00991                   $substringIndex[$currentPosition] = $newSubstring;
<a name="l00992"></a>00992                   unset($substringIndex[$previousPosition]);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994                   <span class="comment">// Move the substring in the length index.</span>
<a name="l00995"></a>00995                   $lengthIndex[$newSubstringLength][$currentPosition] = $newSubstring;
<a name="l00996"></a>00996                   unset($lengthIndex[$newSubstringLength - 1][$previousPosition]);
<a name="l00997"></a>00997                } <span class="keywordflow">else</span> {
<a name="l00998"></a>00998                   <span class="comment">// Start a new common substring...</span>
<a name="l00999"></a>00999                   <span class="comment">// Add the substring to the substring index.</span>
<a name="l01000"></a>01000                   $substringIndex[$currentPosition] = $comparedCharacter;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002                   <span class="comment">// Add the substring to the length index.</span>
<a name="l01003"></a>01003                   $lengthIndex[1][$currentPosition] = $comparedCharacter;
<a name="l01004"></a>01004                }
<a name="l01005"></a>01005             }
<a name="l01006"></a>01006          }
<a name="l01007"></a>01007       }
<a name="l01008"></a>01008 
<a name="l01009"></a>01009       <span class="comment">// If we have no commonalities at all then mark the original</span>
<a name="l01010"></a>01010       <span class="comment">// string as deleted and the edited string as added and</span>
<a name="l01011"></a>01011       <span class="comment">// return.</span>
<a name="l01012"></a>01012       <span class="keywordflow">if</span> (empty($lengthIndex)) {
<a name="l01013"></a>01013          <span class="keywordflow">return</span> array(
<a name="l01014"></a>01014             array( -1 =&gt; $originalString ),
<a name="l01015"></a>01015             array( 1 =&gt; $editedString )
<a name="l01016"></a>01016          );
<a name="l01017"></a>01017       }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019       <span class="comment">// Pop the largest common substrings from the length index.</span>
<a name="l01020"></a>01020       end($lengthIndex);
<a name="l01021"></a>01021       $largestSubstringLength = key($lengthIndex);
<a name="l01022"></a>01022 
<a name="l01023"></a>01023       <span class="comment">// Take the first common substring if we have more than</span>
<a name="l01024"></a>01024       <span class="comment">// one substring with the same length.</span>
<a name="l01025"></a>01025       <span class="comment">// FIXME: Find a better heuristic for this decision.</span>
<a name="l01026"></a>01026       reset($lengthIndex[$largestSubstringLength]);
<a name="l01027"></a>01027       $largestSubstringPosition = key($lengthIndex[$largestSubstringLength]);
<a name="l01028"></a>01028       list($largestSubstringEndOriginal, $largestSubstringEndEdited) = explode(<span class="charliteral">&#39;-&#39;</span>, $largestSubstringPosition);
<a name="l01029"></a>01029       $largestSubstring = $lengthIndex[$largestSubstringLength][$largestSubstringPosition];
<a name="l01030"></a>01030 
<a name="l01031"></a>01031       <span class="comment">// Add the largest common substring to the result set</span>
<a name="l01032"></a>01032       $diffResult = array(array( 0 =&gt; $largestSubstring ));
<a name="l01033"></a>01033 
<a name="l01034"></a>01034       <span class="comment">// Prepend the diff of the substrings before the common substring</span>
<a name="l01035"></a>01035       <span class="comment">// to the result diff (by recursion).</span>
<a name="l01036"></a>01036       $precedingSubstringOriginal = <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($originalString, 0, $largestSubstringEndOriginal-$largestSubstringLength+1);
<a name="l01037"></a>01037       $precedingSubstringEdited = <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($editedString, 0, $largestSubstringEndEdited-$largestSubstringLength+1);
<a name="l01038"></a>01038       $diffResult = array_merge(<a class="code" href="class_string.html#a52e328b071450a7c9f3a041ac70f41ca">String::diff</a>($precedingSubstringOriginal, $precedingSubstringEdited), $diffResult);
<a name="l01039"></a>01039 
<a name="l01040"></a>01040       <span class="comment">// Append the diff of the substrings after thr common substring</span>
<a name="l01041"></a>01041       <span class="comment">// to the result diff (by recursion).</span>
<a name="l01042"></a>01042       $succeedingSubstringOriginal = <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($originalString, $largestSubstringEndOriginal+1);
<a name="l01043"></a>01043       $succeedingSubstringEdited = <a class="code" href="class_string.html#a0c73d75c437c3f87aa3a4f736ae8d0e0">String::substr</a>($editedString, $largestSubstringEndEdited+1);
<a name="l01044"></a>01044       $diffResult = array_merge($diffResult, <a class="code" href="class_string.html#a52e328b071450a7c9f3a041ac70f41ca">String::diff</a>($succeedingSubstringOriginal, $succeedingSubstringEdited));
<a name="l01045"></a>01045 
<a name="l01046"></a>01046       <span class="comment">// Return the array representing the diff.</span>
<a name="l01047"></a>01047       <span class="keywordflow">return</span> $diffResult;
<a name="l01048"></a>01048    }
<a name="l01049"></a>01049 }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 ?&gt;
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Mar 12 2012 16:01:56 for CBP Platform by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
